<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="robots" content="noindex">

	<title>File ProjectsController.php</title>

	<link rel="stylesheet" href="resources/style.css?e99947befd7bf673c6b43ff75e9e0f170c88a60e">

</head>

<body>
<div id="left">
	<div id="menu">
		<a href="index.html" title="Overview"><span>Overview</span></a>


		<div id="groups">
				<h3>Packages</h3>
			<ul>
				<li class="active">
					<a href="package-app.html">
						app<span></span>
					</a>

						<ul>
				<li>
					<a href="package-app.Controller.html">
						Controller					</a>

						</li>
				<li>
					<a href="package-app.Lib.html">
						Lib					</a>

						</li>
				<li class="active">
					<a href="package-app.Model.html">
						Model					</a>

						</li>
							</ul></li>
			</ul>
		</div>

		<hr>


		<div id="elements">
			<h3>Classes</h3>
			<ul>
				<li><a href="class-AppModel.html">AppModel</a></li>
				<li><a href="class-Export.html">Export</a></li>
				<li><a href="class-Input.html">Input</a></li>
				<li><a href="class-Log.html">Log</a></li>
				<li><a href="class-Measure.html">Measure</a></li>
				<li><a href="class-Method.html">Method</a></li>
				<li><a href="class-Project.html">Project</a></li>
				<li><a href="class-Unit.html">Unit</a></li>
				<li><a href="class-User.html">User</a></li>
				<li><a href="class-Value.html">Value</a></li>
			</ul>





		</div>
	</div>
</div>

<div id="splitter"></div>

<div id="right">
<div id="rightInner">
	<form id="search">
		<input type="hidden" name="cx" value="">
		<input type="hidden" name="ie" value="UTF-8">
		<input type="text" name="q" class="text" placeholder="Search">
	</form>

	<div id="navigation">
		<ul>
			<li>
				<a href="index.html" title="Overview"><span>Overview</span></a>
			</li>
			<li>
				<a href="package-app.Model.html" title="Summary of app\Model"><span>Package</span></a>
			</li>
			<li>
				<a href="class-ValuesController.html" title="Summary of ValuesController"><span>Class</span></a>
			</li>
		</ul>
		<ul>
			<li>
				<a href="todo.html" title="Todo list"><span>Todo</span></a>
			</li>
		</ul>
		<ul>
		</ul>
	</div>

<pre><code><span id="1" class="l"><a href="#1">  1: </a><span class="xlang">&lt;?php</span>
</span><span id="2" class="l"><a href="#2">  2: </a><span class="php-comment">/**
</span></span><span id="3" class="l"><a href="#3">  3: </a><span class="php-comment"> * Projects Controller
</span></span><span id="4" class="l"><a href="#4">  4: </a><span class="php-comment"> *
</span></span><span id="5" class="l"><a href="#5">  5: </a><span class="php-comment"> * Provides all project related functions.
</span></span><span id="6" class="l"><a href="#6">  6: </a><span class="php-comment"> *
</span></span><span id="7" class="l"><a href="#7">  7: </a><span class="php-comment"> * @copyright     Martin Kapp 2014-15
</span></span><span id="8" class="l"><a href="#8">  8: </a><span class="php-comment"> * @link          http://headkino.de
</span></span><span id="9" class="l"><a href="#9">  9: </a><span class="php-comment"> * @package       app.Controller
</span></span><span id="10" class="l"><a href="#10"> 10: </a><span class="php-comment"> * @since         v 0.1
</span></span><span id="11" class="l"><a href="#11"> 11: </a><span class="php-comment"> * @license       MIT License (http://www.opensource.org/licenses/mit-license.php)
</span></span><span id="12" class="l"><a href="#12"> 12: </a><span class="php-comment"> */</span>
</span><span id="13" class="l"><a href="#13"> 13: </a>App::uses(<span class="php-quote">'AppController'</span>, <span class="php-quote">'Controller'</span>);
</span><span id="14" class="l"><a href="#14"> 14: </a><span class="php-comment">/**
</span></span><span id="15" class="l"><a href="#15"> 15: </a><span class="php-comment"> * Projects Controller
</span></span><span id="16" class="l"><a href="#16"> 16: </a><span class="php-comment"> *
</span></span><span id="17" class="l"><a href="#17"> 17: </a><span class="php-comment"> * @property Project $Project
</span></span><span id="18" class="l"><a href="#18"> 18: </a><span class="php-comment"> */</span>
</span><span id="19" class="l"><a href="#19"> 19: </a><span class="php-keyword1">class</span> ProjectsController <span class="php-keyword1">extends</span> AppController {
</span><span id="20" class="l"><a href="#20"> 20: </a>
</span><span id="21" class="l"><a href="#21"> 21: </a>    <span class="php-comment">/**
</span></span><span id="22" class="l"><a href="#22"> 22: </a><span class="php-comment">     * Shows a list of all for the users visible projects.
</span></span><span id="23" class="l"><a href="#23"> 23: </a><span class="php-comment">     * @return void
</span></span><span id="24" class="l"><a href="#24"> 24: </a><span class="php-comment">     */</span>
</span><span id="25" class="l"><a href="#25"> 25: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> index() {
</span><span id="26" class="l"><a href="#26"> 26: </a>        <span class="php-var">$this</span>-&gt;Session-&gt;write(<span class="php-quote">'Project'</span>, <span class="php-keyword1">false</span>);
</span><span id="27" class="l"><a href="#27"> 27: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'isAdmin'</span>)) {
</span><span id="28" class="l"><a href="#28"> 28: </a>            <span class="php-var">$this</span>-&gt;Project-&gt;recursive = <span class="php-num">0</span>;
</span><span id="29" class="l"><a href="#29"> 29: </a>            <span class="php-var">$projects</span> = <span class="php-var">$this</span>-&gt;Project-&gt;find(<span class="php-quote">'all'</span>);
</span><span id="30" class="l"><a href="#30"> 30: </a>            <span class="php-var">$projects</span> = Set::<span class="php-keyword2">extract</span>(<span class="php-var">$projects</span>, <span class="php-quote">'{n}.Project'</span>);
</span><span id="31" class="l"><a href="#31"> 31: </a>        } <span class="php-keyword1">else</span> {
</span><span id="32" class="l"><a href="#32"> 32: </a>            <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'User'</span>);
</span><span id="33" class="l"><a href="#33"> 33: </a>            <span class="php-var">$this</span>-&gt;User-&gt;recursive = <span class="php-num">1</span>;
</span><span id="34" class="l"><a href="#34"> 34: </a>            <span class="php-var">$user</span> = <span class="php-var">$this</span>-&gt;User-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>));
</span><span id="35" class="l"><a href="#35"> 35: </a>            <span class="php-var">$projects</span> = <span class="php-var">$user</span>[<span class="php-quote">'Project'</span>];
</span><span id="36" class="l"><a href="#36"> 36: </a>        }
</span><span id="37" class="l"><a href="#37"> 37: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-quote">'projects'</span>, <span class="php-var">$projects</span>);
</span><span id="38" class="l"><a href="#38"> 38: </a>    }
</span><span id="39" class="l"><a href="#39"> 39: </a>
</span><span id="40" class="l"><a href="#40"> 40: </a>    <span class="php-comment">/**
</span></span><span id="41" class="l"><a href="#41"> 41: </a><span class="php-comment">     * Shows a glance of a project with all Values, Inputs, Project Members, Methods, Units
</span></span><span id="42" class="l"><a href="#42"> 42: </a><span class="php-comment">     * @throws NotFoundException
</span></span><span id="43" class="l"><a href="#43"> 43: </a><span class="php-comment">     * @param string $id
</span></span><span id="44" class="l"><a href="#44"> 44: </a><span class="php-comment">     * @return void
</span></span><span id="45" class="l"><a href="#45"> 45: </a><span class="php-comment">     */</span>
</span><span id="46" class="l"><a href="#46"> 46: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> view(<span class="php-var">$id</span> = <span class="php-keyword1">null</span>) {
</span><span id="47" class="l"><a href="#47"> 47: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;id = <span class="php-var">$id</span>;
</span><span id="48" class="l"><a href="#48"> 48: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;recursive = <span class="php-num">1</span>;
</span><span id="49" class="l"><a href="#49"> 49: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Project-&gt;exists()) {
</span><span id="50" class="l"><a href="#50"> 50: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid project'</span>));
</span><span id="51" class="l"><a href="#51"> 51: </a>        }
</span><span id="52" class="l"><a href="#52"> 52: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;Behaviors-&gt;load(<span class="php-quote">'Containable'</span>);
</span><span id="53" class="l"><a href="#53"> 53: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Method'</span>);
</span><span id="54" class="l"><a href="#54"> 54: </a>        <span class="php-var">$p</span> = <span class="php-var">$this</span>-&gt;Project-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Project.id'</span> =&gt; <span class="php-var">$id</span>), <span class="php-quote">'contain'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Value'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'order'</span> =&gt; <span class="php-quote">'Value.name ASC'</span>, <span class="php-quote">'Input'</span>, <span class="php-quote">'Unit'</span>, <span class="php-quote">'Method'</span>), <span class="php-quote">'Member'</span>, <span class="php-quote">'Input'</span>, <span class="php-quote">'Export'</span>, <span class="php-quote">'Method'</span>, <span class="php-quote">'Unit'</span>)));
</span><span id="55" class="l"><a href="#55"> 55: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$p</span>[<span class="php-quote">'Value'</span>] <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt;  <span class="php-var">$v</span>) {
</span><span id="56" class="l"><a href="#56"> 56: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$v</span>[<span class="php-quote">'method_id'</span>])
</span><span id="57" class="l"><a href="#57"> 57: </a>                <span class="php-var">$p</span>[<span class="php-quote">'Value'</span>][<span class="php-var">$i</span>][<span class="php-quote">'execName'</span>] = <span class="php-var">$this</span>-&gt;Method-&gt;getExecName(<span class="php-var">$v</span>[<span class="php-quote">'Method'</span>][<span class="php-quote">'name'</span>], <span class="php-var">$v</span>[<span class="php-quote">'Method'</span>][<span class="php-quote">'params'</span>], <span class="php-var">$v</span>[<span class="php-quote">'method_params'</span>], Set::combine(<span class="php-var">$p</span>[<span class="php-quote">'Value'</span>], <span class="php-quote">'{n}.id'</span>, <span class="php-quote">'{n}'</span>));
</span><span id="58" class="l"><a href="#58"> 58: </a>        }
</span><span id="59" class="l"><a href="#59"> 59: </a>        <span class="php-comment">//debug($p);</span>
</span><span id="60" class="l"><a href="#60"> 60: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-quote">'project'</span>, <span class="php-var">$p</span>);
</span><span id="61" class="l"><a href="#61"> 61: </a>        <span class="php-var">$this</span>-&gt;project_set_session(<span class="php-var">$p</span>);
</span><span id="62" class="l"><a href="#62"> 62: </a>    }
</span><span id="63" class="l"><a href="#63"> 63: </a>    
</span><span id="64" class="l"><a href="#64"> 64: </a>    
</span><span id="65" class="l"><a href="#65"> 65: </a>    <span class="php-comment">/**
</span></span><span id="66" class="l"><a href="#66"> 66: </a><span class="php-comment">    * returns a link list with files that could be imported from a source URL for an input
</span></span><span id="67" class="l"><a href="#67"> 67: </a><span class="php-comment">    * @param mixed $input input_id or input record from database to get array of links from source
</span></span><span id="68" class="l"><a href="#68"> 68: </a><span class="php-comment">    * @return array of links
</span></span><span id="69" class="l"><a href="#69"> 69: </a><span class="php-comment">    */</span>
</span><span id="70" class="l"><a href="#70"> 70: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> get_import_list(<span class="php-var">$input</span>){
</span><span id="71" class="l"><a href="#71"> 71: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$input</span>)) {
</span><span id="72" class="l"><a href="#72"> 72: </a>            <span class="php-var">$this</span>-&gt;Project-&gt;recursive = <span class="php-num">0</span>;
</span><span id="73" class="l"><a href="#73"> 73: </a>            <span class="php-var">$input</span> = <span class="php-var">$this</span>-&gt;Project-&gt;Input-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$input</span>);
</span><span id="74" class="l"><a href="#74"> 74: </a>        }
</span><span id="75" class="l"><a href="#75"> 75: </a>        <span class="php-keyword1">if</span>(!<span class="php-keyword2">trim</span>(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'list_url'</span>])){
</span><span id="76" class="l"><a href="#76"> 76: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'There is no source list URL provided in the input. Please edit the input and add the needed parameters to fetch the data.'</span>));
</span><span id="77" class="l"><a href="#77"> 77: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="78" class="l"><a href="#78"> 78: </a>        }
</span><span id="79" class="l"><a href="#79"> 79: </a>        <span class="php-var">$f</span> = @<span class="php-keyword2">file_get_contents</span>(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'list_url'</span>]);
</span><span id="80" class="l"><a href="#80"> 80: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$f</span>) {
</span><span id="81" class="l"><a href="#81"> 81: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'The provided source list URL returns en empty result or cannot be found.'</span>));
</span><span id="82" class="l"><a href="#82"> 82: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>();
</span><span id="83" class="l"><a href="#83"> 83: </a>        }
</span><span id="84" class="l"><a href="#84"> 84: </a>        <span class="php-var">$f</span> = console::pre_regex(<span class="php-var">$f</span>);
</span><span id="85" class="l"><a href="#85"> 85: </a>        <span class="php-comment">//debug($input['Input']['link_regex']);</span>
</span><span id="86" class="l"><a href="#86"> 86: </a>        <span class="php-keyword2">preg_match_all</span>(<span class="php-quote">'#'</span>.<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'link_regex'</span>].<span class="php-quote">'#'</span>, <span class="php-var">$f</span>, <span class="php-var">$m</span>);
</span><span id="87" class="l"><a href="#87"> 87: </a>        <span class="php-var">$links</span> = <span class="php-var">$m</span>[<span class="php-num">0</span>];
</span><span id="88" class="l"><a href="#88"> 88: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$links</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$l</span>)
</span><span id="89" class="l"><a href="#89"> 89: </a>            <span class="php-var">$links</span>[<span class="php-var">$i</span>] = f::url_to_absolute(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'list_url'</span>], <span class="php-var">$l</span>);
</span><span id="90" class="l"><a href="#90"> 90: </a>        <span class="php-keyword1">return</span> <span class="php-var">$links</span>;
</span><span id="91" class="l"><a href="#91"> 91: </a>    }
</span><span id="92" class="l"><a href="#92"> 92: </a>    
</span><span id="93" class="l"><a href="#93"> 93: </a>    <span class="php-comment">/**
</span></span><span id="94" class="l"><a href="#94"> 94: </a><span class="php-comment">    * returns all already imported urls from a source
</span></span><span id="95" class="l"><a href="#95"> 95: </a><span class="php-comment">    * @param mixed $input input_id or input record from database to get already imported links from logs
</span></span><span id="96" class="l"><a href="#96"> 96: </a><span class="php-comment">    * @return array of logs from database
</span></span><span id="97" class="l"><a href="#97"> 97: </a><span class="php-comment">    */</span>
</span><span id="98" class="l"><a href="#98"> 98: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> get_imported_links(<span class="php-var">$input</span>){
</span><span id="99" class="l"><a href="#99"> 99: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$input</span>)) {
</span><span id="100" class="l"><a href="#100">100: </a>            <span class="php-var">$input</span> = <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'id'</span>];
</span><span id="101" class="l"><a href="#101">101: </a>        }
</span><span id="102" class="l"><a href="#102">102: </a>        <span class="php-var">$from_url</span> = <span class="php-var">$this</span>-&gt;getLogs(<span class="php-quote">'imported_url'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'related_id'</span> =&gt; <span class="php-var">$input</span>), <span class="php-quote">'data_2'</span>); <span class="php-comment">//data_2 is the filename of the raw data file in the log table</span>
</span><span id="103" class="l"><a href="#103">103: </a>        <span class="php-var">$from_file</span> = <span class="php-var">$this</span>-&gt;getLogs(<span class="php-quote">'imported_file'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'related_id'</span> =&gt; <span class="php-var">$input</span>), <span class="php-quote">'data_2'</span>); <span class="php-comment">//data_2 is the filename of the raw data file in the log table</span>
</span><span id="104" class="l"><a href="#104">104: </a>        <span class="php-var">$logs</span> = <span class="php-keyword1">array</span>();
</span><span id="105" class="l"><a href="#105">105: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$from_file</span> <span class="php-keyword1">as</span> <span class="php-var">$file</span> =&gt; <span class="php-var">$ff</span>){
</span><span id="106" class="l"><a href="#106">106: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">is_array</span>(<span class="php-var">$from_url</span>[<span class="php-var">$file</span>])) {
</span><span id="107" class="l"><a href="#107">107: </a>                <span class="php-var">$from_url</span>[<span class="php-var">$file</span>] = <span class="php-keyword1">array</span>();
</span><span id="108" class="l"><a href="#108">108: </a>                <span class="php-keyword1">continue</span>;
</span><span id="109" class="l"><a href="#109">109: </a>            }
</span><span id="110" class="l"><a href="#110">110: </a>            <span class="php-var">$logs</span>[<span class="php-var">$from_url</span>[<span class="php-var">$file</span>][<span class="php-quote">'data'</span>]] = <span class="php-keyword2">array_merge</span>(<span class="php-var">$from_url</span>[<span class="php-var">$file</span>], <span class="php-var">$ff</span>);
</span><span id="111" class="l"><a href="#111">111: </a>        }
</span><span id="112" class="l"><a href="#112">112: </a>        <span class="php-keyword2">ksort</span>(<span class="php-var">$logs</span>);
</span><span id="113" class="l"><a href="#113">113: </a>        <span class="php-keyword1">return</span> <span class="php-var">$logs</span>;
</span><span id="114" class="l"><a href="#114">114: </a>    }
</span><span id="115" class="l"><a href="#115">115: </a>    
</span><span id="116" class="l"><a href="#116">116: </a>    <span class="php-comment">/**
</span></span><span id="117" class="l"><a href="#117">117: </a><span class="php-comment">    * Updates all imports by fetching the data from all project related input sources
</span></span><span id="118" class="l"><a href="#118">118: </a><span class="php-comment">    * @param project_id Project id of the project for which the imports should be updated
</span></span><span id="119" class="l"><a href="#119">119: </a><span class="php-comment">    */</span>
</span><span id="120" class="l"><a href="#120">120: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> update_all_imports(<span class="php-var">$project_id</span>) {
</span><span id="121" class="l"><a href="#121">121: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Input'</span>);
</span><span id="122" class="l"><a href="#122">122: </a>        <span class="php-var">$inputs</span> = <span class="php-var">$this</span>-&gt;Input-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Input.project_id'</span> =&gt; <span class="php-var">$project_id</span>)));
</span><span id="123" class="l"><a href="#123">123: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$inputs</span>))
</span><span id="124" class="l"><a href="#124">124: </a>            <span class="php-var">$inputs</span> = <span class="php-keyword2">array_keys</span>(<span class="php-var">$inputs</span>);
</span><span id="125" class="l"><a href="#125">125: </a>        <span class="php-keyword1">else</span>
</span><span id="126" class="l"><a href="#126">126: </a>            <span class="php-var">$inputs</span> = <span class="php-keyword1">array</span>();
</span><span id="127" class="l"><a href="#127">127: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$inputs</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span>){
</span><span id="128" class="l"><a href="#128">128: </a>            <span class="php-var">$this</span>-&gt;update_imports(<span class="php-var">$i</span>);
</span><span id="129" class="l"><a href="#129">129: </a>        }
</span><span id="130" class="l"><a href="#130">130: </a>        <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'../dummy'</span>);
</span><span id="131" class="l"><a href="#131">131: </a>    }
</span><span id="132" class="l"><a href="#132">132: </a>    
</span><span id="133" class="l"><a href="#133">133: </a>    <span class="php-comment">/**
</span></span><span id="134" class="l"><a href="#134">134: </a><span class="php-comment">    * imports either all passed links into the system or checks the list-URL of an input for new data if there is something new to import
</span></span><span id="135" class="l"><a href="#135">135: </a><span class="php-comment">    * @param $input_id of the input for which to check for new files from source
</span></span><span id="136" class="l"><a href="#136">136: </a><span class="php-comment">    * @param $links array of links to remote files which should be imported, if not provided, the input source is checked for new links
</span></span><span id="137" class="l"><a href="#137">137: </a><span class="php-comment">    * @param $_GET[link]
</span></span><span id="138" class="l"><a href="#138">138: </a><span class="php-comment">    * @return true or false for import succeeded or not
</span></span><span id="139" class="l"><a href="#139">139: </a><span class="php-comment">    */</span>
</span><span id="140" class="l"><a href="#140">140: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> update_imports(<span class="php-var">$input_id</span> = <span class="php-keyword1">null</span>, <span class="php-var">$links</span> = <span class="php-keyword1">false</span>) {
</span><span id="141" class="l"><a href="#141">141: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$input_id</span>) {
</span><span id="142" class="l"><a href="#142">142: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="143" class="l"><a href="#143">143: </a>        }
</span><span id="144" class="l"><a href="#144">144: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$links</span> &amp;&amp; <span class="php-var">$link</span> = <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'link'</span>])
</span><span id="145" class="l"><a href="#145">145: </a>            <span class="php-var">$links</span> = <span class="php-keyword1">array</span>(<span class="php-var">$link</span>);
</span><span id="146" class="l"><a href="#146">146: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$links</span> &amp;&amp; !<span class="php-keyword2">is_array</span>(<span class="php-var">$links</span>))
</span><span id="147" class="l"><a href="#147">147: </a>            <span class="php-var">$links</span> = <span class="php-keyword1">array</span>(<span class="php-var">$links</span>);
</span><span id="148" class="l"><a href="#148">148: </a>
</span><span id="149" class="l"><a href="#149">149: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Input'</span>);
</span><span id="150" class="l"><a href="#150">150: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Log'</span>);
</span><span id="151" class="l"><a href="#151">151: </a>        <span class="php-var">$this</span>-&gt;Input-&gt;id = <span class="php-var">$input_id</span>;
</span><span id="152" class="l"><a href="#152">152: </a>        <span class="php-var">$this</span>-&gt;Input-&gt;recursive = <span class="php-num">1</span>;
</span><span id="153" class="l"><a href="#153">153: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Input-&gt;exists()) {<span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid Input'</span>));}
</span><span id="154" class="l"><a href="#154">154: </a>        <span class="php-var">$input</span> = <span class="php-var">$this</span>-&gt;Input-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$input_id</span>);
</span><span id="155" class="l"><a href="#155">155: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$lurl</span> = <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'list_url'</span>] || <span class="php-var">$links</span> || <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'auto'</span>]) {
</span><span id="156" class="l"><a href="#156">156: </a>            <span class="php-keyword1">if</span>(!<span class="php-var">$links</span>) { <span class="php-comment">//No link list given</span>
</span><span id="157" class="l"><a href="#157">157: </a>                <span class="php-var">$links</span> = <span class="php-var">$this</span>-&gt;get_import_list(<span class="php-var">$input</span>); <span class="php-comment">//Get links to fetch</span>
</span><span id="158" class="l"><a href="#158">158: </a>                <span class="php-var">$logs</span> = <span class="php-var">$this</span>-&gt;get_imported_links(<span class="php-var">$input</span>); <span class="php-comment">//Get already imported links</span>
</span><span id="159" class="l"><a href="#159">159: </a>                <span class="php-keyword2">set_time_limit</span>(<span class="php-num">600</span>);
</span><span id="160" class="l"><a href="#160">160: </a>            } <span class="php-keyword1">else</span> {
</span><span id="161" class="l"><a href="#161">161: </a>                <span class="php-var">$import_all</span> = <span class="php-keyword1">true</span>;
</span><span id="162" class="l"><a href="#162">162: </a>            }
</span><span id="163" class="l"><a href="#163">163: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$links</span> <span class="php-keyword1">as</span> <span class="php-var">$l</span>) { <span class="php-comment">//Import all links</span>
</span><span id="164" class="l"><a href="#164">164: </a>                <span class="php-keyword1">if</span>(!<span class="php-var">$logs</span>[<span class="php-var">$l</span>] || <span class="php-var">$import_all</span>) {
</span><span id="165" class="l"><a href="#165">165: </a>                    <span class="php-var">$filename</span> = <span class="php-var">$this</span>-&gt;store_data(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'id'</span>], <span class="php-var">$l</span>, <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'page_container'</span>]); <span class="php-comment">//store raw data file</span>
</span><span id="166" class="l"><a href="#166">166: </a>                    <span class="php-var">$imported</span> = <span class="php-var">$this</span>-&gt;import(<span class="php-var">$input_id</span>, <span class="php-var">$filename</span>);
</span><span id="167" class="l"><a href="#167">167: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$imported</span>[<span class="php-quote">'imported'</span>]) {
</span><span id="168" class="l"><a href="#168">168: </a>                        <span class="php-var">$this</span>-&gt;check_data(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'project_id'</span>], <span class="php-var">$imported</span>[<span class="php-quote">'earliest'</span>], <span class="php-var">$imported</span>[<span class="php-quote">'latest'</span>]);
</span><span id="169" class="l"><a href="#169">169: </a>                        <span class="php-var">$this</span>-&gt;calculate_values(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'project_id'</span>], <span class="php-keyword1">array</span>(<span class="php-quote">'start'</span> =&gt; <span class="php-var">$imported</span>[<span class="php-quote">'earliest'</span>], <span class="php-quote">'end'</span> =&gt; <span class="php-var">$imported</span>[<span class="php-quote">'latest'</span>])); <span class="php-comment">//Calculate values for time range</span>
</span><span id="170" class="l"><a href="#170">170: </a>                    }
</span><span id="171" class="l"><a href="#171">171: </a>                }
</span><span id="172" class="l"><a href="#172">172: </a>            }
</span><span id="173" class="l"><a href="#173">173: </a>        }
</span><span id="174" class="l"><a href="#174">174: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-quote">'import_succeeded'</span>, <span class="php-keyword1">true</span>);
</span><span id="175" class="l"><a href="#175">175: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-quote">'imported'</span>, <span class="php-var">$imported</span>);
</span><span id="176" class="l"><a href="#176">176: </a>        <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'../dummy'</span>);
</span><span id="177" class="l"><a href="#177">177: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
</span><span id="178" class="l"><a href="#178">178: </a>    }
</span><span id="179" class="l"><a href="#179">179: </a>    
</span><span id="180" class="l"><a href="#180">180: </a>    <span class="php-comment">/**
</span></span><span id="181" class="l"><a href="#181">181: </a><span class="php-comment">    * Imports a manually uploaded file or makes a guided import from the source URL of an input
</span></span><span id="182" class="l"><a href="#182">182: </a><span class="php-comment">    * @param id project id for which the upload shell be performed, if not provided the current id is read from the session
</span></span><span id="183" class="l"><a href="#183">183: </a><span class="php-comment">    * @return void
</span></span><span id="184" class="l"><a href="#184">184: </a><span class="php-comment">    */</span>
</span><span id="185" class="l"><a href="#185">185: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> upload_import(<span class="php-var">$id</span> = <span class="php-keyword1">null</span>) {
</span><span id="186" class="l"><a href="#186">186: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$id</span>) {
</span><span id="187" class="l"><a href="#187">187: </a>            <span class="php-var">$id</span> = <span class="php-var">$this</span>-&gt;Session-&gt;read(<span class="php-quote">'Project'</span>);
</span><span id="188" class="l"><a href="#188">188: </a>            <span class="php-var">$id</span> = <span class="php-var">$id</span>[<span class="php-quote">'id'</span>];
</span><span id="189" class="l"><a href="#189">189: </a>        }
</span><span id="190" class="l"><a href="#190">190: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;id = <span class="php-var">$id</span>;
</span><span id="191" class="l"><a href="#191">191: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;recursive = <span class="php-num">0</span>;
</span><span id="192" class="l"><a href="#192">192: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Project-&gt;exists()) {<span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid project'</span>));}
</span><span id="193" class="l"><a href="#193">193: </a>        
</span><span id="194" class="l"><a href="#194">194: </a>        <span class="php-comment">//import from source, show list of importable links to be imported with update_imports via AJAX</span>
</span><span id="195" class="l"><a href="#195">195: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'import_source'</span>]){ 
</span><span id="196" class="l"><a href="#196">196: </a>            <span class="php-var">$input</span> = <span class="php-var">$this</span>-&gt;Project-&gt;Input-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Input'</span>]);
</span><span id="197" class="l"><a href="#197">197: </a>            <span class="php-var">$links</span> = <span class="php-var">$this</span>-&gt;get_import_list(<span class="php-var">$input</span>);
</span><span id="198" class="l"><a href="#198">198: </a>            <span class="php-var">$imported_links</span> = <span class="php-var">$this</span>-&gt;get_imported_links(<span class="php-var">$input</span>);
</span><span id="199" class="l"><a href="#199">199: </a>            <span class="php-keyword1">if</span>(!<span class="php-keyword2">count</span>(<span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'list_url'</span>])){
</span><span id="200" class="l"><a href="#200">200: </a>                <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'There was no input source url found. Please define a List URL by editing the input %s'</span>, <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'name'</span>]));
</span><span id="201" class="l"><a href="#201">201: </a>            }
</span><span id="202" class="l"><a href="#202">202: </a>            <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'links'</span>, <span class="php-quote">'input'</span>, <span class="php-quote">'imported_links'</span>));
</span><span id="203" class="l"><a href="#203">203: </a>        } <span class="php-keyword1">else</span>
</span><span id="204" class="l"><a href="#204">204: </a>        
</span><span id="205" class="l"><a href="#205">205: </a>        <span class="php-comment">//import from uploaded file manually</span>
</span><span id="206" class="l"><a href="#206">206: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'post'</span>) &amp;&amp; <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'import_file'</span>][<span class="php-quote">'name'</span>]) { 
</span><span id="207" class="l"><a href="#207">207: </a>            <span class="php-var">$filename</span> = <span class="php-var">$this</span>-&gt;store_data(<span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Input'</span>]);
</span><span id="208" class="l"><a href="#208">208: </a>            <span class="php-var">$imported</span> = <span class="php-var">$this</span>-&gt;import(<span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Input'</span>], <span class="php-var">$filename</span>);
</span><span id="209" class="l"><a href="#209">209: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$imported</span>[<span class="php-quote">'imported'</span>]) {
</span><span id="210" class="l"><a href="#210">210: </a>                <span class="php-var">$this</span>-&gt;check_data(<span class="php-var">$id</span>, <span class="php-var">$imported</span>[<span class="php-quote">'earliest'</span>], <span class="php-var">$imported</span>[<span class="php-quote">'latest'</span>]);
</span><span id="211" class="l"><a href="#211">211: </a>                <span class="php-var">$this</span>-&gt;calculate_values(<span class="php-var">$id</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'start'</span> =&gt; <span class="php-var">$imported</span>[<span class="php-quote">'earliest'</span>], <span class="php-quote">'end'</span> =&gt; <span class="php-var">$imported</span>[<span class="php-quote">'latest'</span>])); <span class="php-comment">//Calculate values for time range</span>
</span><span id="212" class="l"><a href="#212">212: </a>                <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'data'</span>, <span class="php-var">$id</span>, <span class="php-quote">'?'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'start'</span> =&gt; <span class="php-keyword2">date</span>(<span class="php-quote">'d.m.Y'</span>,<span class="php-var">$imported</span>[<span class="php-quote">'earliest'</span>]), <span class="php-quote">'end'</span> =&gt; <span class="php-keyword2">date</span>(<span class="php-quote">'d.m.Y'</span>,<span class="php-var">$imported</span>[<span class="php-quote">'latest'</span>]))));
</span><span id="213" class="l"><a href="#213">213: </a>            }
</span><span id="214" class="l"><a href="#214">214: </a>            
</span><span id="215" class="l"><a href="#215">215: </a>        }
</span><span id="216" class="l"><a href="#216">216: </a>        
</span><span id="217" class="l"><a href="#217">217: </a>        <span class="php-var">$project</span> = <span class="php-var">$this</span>-&gt;Project-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$id</span>);
</span><span id="218" class="l"><a href="#218">218: </a>        <span class="php-var">$project_id</span> = <span class="php-var">$id</span>;
</span><span id="219" class="l"><a href="#219">219: </a>        <span class="php-var">$inputs</span> = <span class="php-var">$this</span>-&gt;Project-&gt;Input-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-quote">'project_id=&quot;'</span>.<span class="php-var">$id</span>.<span class="php-quote">'&quot;'</span>));
</span><span id="220" class="l"><a href="#220">220: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'project'</span>, <span class="php-quote">'inputs'</span>, <span class="php-quote">'input'</span>, <span class="php-quote">'project_id'</span>));
</span><span id="221" class="l"><a href="#221">221: </a>        <span class="php-var">$this</span>-&gt;project_set_session(<span class="php-var">$project</span>);
</span><span id="222" class="l"><a href="#222">222: </a>        <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'import'</span>);
</span><span id="223" class="l"><a href="#223">223: </a>    }
</span><span id="224" class="l"><a href="#224">224: </a>    
</span><span id="225" class="l"><a href="#225">225: </a>    <span class="php-comment">/**
</span></span><span id="226" class="l"><a href="#226">226: </a><span class="php-comment">    * Imports a locally stored file into the database
</span></span><span id="227" class="l"><a href="#227">227: </a><span class="php-comment">    * @param $input_id of the Input, that maps the data onto the values
</span></span><span id="228" class="l"><a href="#228">228: </a><span class="php-comment">    * @param $filename relative filepath to the file to be imported
</span></span><span id="229" class="l"><a href="#229">229: </a><span class="php-comment">    * @return array [
</span></span><span id="230" class="l"><a href="#230">230: </a><span class="php-comment">    *   imported: true or false for import succeeded or not not, 
</span></span><span id="231" class="l"><a href="#231">231: </a><span class="php-comment">    *   earliest: earliest timestamp imported, 
</span></span><span id="232" class="l"><a href="#232">232: </a><span class="php-comment">    *   latest: latest timestamp imported
</span></span><span id="233" class="l"><a href="#233">233: </a><span class="php-comment">    * ]
</span></span><span id="234" class="l"><a href="#234">234: </a><span class="php-comment">    */</span>
</span><span id="235" class="l"><a href="#235">235: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> import(<span class="php-var">$input_id</span> = <span class="php-keyword1">null</span>, <span class="php-var">$filename</span> = <span class="php-keyword1">null</span>) {
</span><span id="236" class="l"><a href="#236">236: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$filename</span>) {
</span><span id="237" class="l"><a href="#237">237: </a>            <span class="php-var">$filename</span> = <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'filename'</span>];
</span><span id="238" class="l"><a href="#238">238: </a>        }
</span><span id="239" class="l"><a href="#239">239: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$input_id</span> || !<span class="php-var">$filename</span>) {
</span><span id="240" class="l"><a href="#240">240: </a>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
</span><span id="241" class="l"><a href="#241">241: </a>        }
</span><span id="242" class="l"><a href="#242">242: </a>        <span class="php-var">$real_filename</span> = <span class="php-var">$filename</span>;
</span><span id="243" class="l"><a href="#243">243: </a>        <span class="php-var">$filename</span> = <span class="php-quote">'../webroot'</span>.<span class="php-var">$filename</span>;
</span><span id="244" class="l"><a href="#244">244: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Measure'</span>);
</span><span id="245" class="l"><a href="#245">245: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Value'</span>);
</span><span id="246" class="l"><a href="#246">246: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Input'</span>);
</span><span id="247" class="l"><a href="#247">247: </a>        <span class="php-var">$this</span>-&gt;Input-&gt;id = <span class="php-var">$input_id</span>;
</span><span id="248" class="l"><a href="#248">248: </a>        <span class="php-var">$this</span>-&gt;Input-&gt;recursive = <span class="php-num">1</span>;
</span><span id="249" class="l"><a href="#249">249: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Input-&gt;exists()) {<span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid Input'</span>));}
</span><span id="250" class="l"><a href="#250">250: </a>        <span class="php-var">$input</span> = <span class="php-var">$this</span>-&gt;Input-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$input_id</span>);
</span><span id="251" class="l"><a href="#251">251: </a>        
</span><span id="252" class="l"><a href="#252">252: </a>        <span class="php-var">$type</span> = <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'type'</span>];
</span><span id="253" class="l"><a href="#253">253: </a>        <span class="php-var">$import_timestamp</span> = <span class="php-keyword2">time</span>();
</span><span id="254" class="l"><a href="#254">254: </a>
</span><span id="255" class="l"><a href="#255">255: </a>        <span class="php-keyword1">switch</span>(<span class="php-var">$type</span>) {
</span><span id="256" class="l"><a href="#256">256: </a>            <span class="php-keyword1">case</span> <span class="php-quote">&quot;text&quot;</span>: <span class="php-var">$measures</span> = <span class="php-var">$this</span>-&gt;parseTEXT(
</span><span id="257" class="l"><a href="#257">257: </a>                    <span class="php-var">$filename</span>, 
</span><span id="258" class="l"><a href="#258">258: </a>                    <span class="php-var">$input</span>[<span class="php-quote">'Value'</span>], 
</span><span id="259" class="l"><a href="#259">259: </a>                    <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'delimiter'</span>], 
</span><span id="260" class="l"><a href="#260">260: </a>                    <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'data_row'</span>], 
</span><span id="261" class="l"><a href="#261">261: </a>                    <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'timestamp_pos'</span>], 
</span><span id="262" class="l"><a href="#262">262: </a>                    <span class="php-var">$input</span>[<span class="php-quote">'Input'</span>][<span class="php-quote">'timestamp_format'</span>]
</span><span id="263" class="l"><a href="#263">263: </a>                );
</span><span id="264" class="l"><a href="#264">264: </a>            <span class="php-keyword1">break</span>;
</span><span id="265" class="l"><a href="#265">265: </a>            <span class="php-keyword1">case</span> <span class="php-quote">&quot;json&quot;</span>: <span class="php-keyword1">break</span>;
</span><span id="266" class="l"><a href="#266">266: </a>            <span class="php-keyword1">case</span> <span class="php-quote">&quot;xml&quot;</span>: <span class="php-keyword1">break</span>;
</span><span id="267" class="l"><a href="#267">267: </a>        }
</span><span id="268" class="l"><a href="#268">268: </a>        <span class="php-var">$earliest</span> = console::<span class="php-var">$maxTime</span>;
</span><span id="269" class="l"><a href="#269">269: </a>        <span class="php-var">$latest</span> = console::<span class="php-var">$minTime</span>;
</span><span id="270" class="l"><a href="#270">270: </a>        <span class="php-var">$values</span> = <span class="php-keyword1">array</span>();
</span><span id="271" class="l"><a href="#271">271: </a>        <span class="php-var">$lines</span> = <span class="php-keyword1">array</span>();
</span><span id="272" class="l"><a href="#272">272: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$measures</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$m</span>){
</span><span id="273" class="l"><a href="#273">273: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$m</span>[<span class="php-quote">'timestamp'</span>] &gt; <span class="php-var">$latest</span>)
</span><span id="274" class="l"><a href="#274">274: </a>                <span class="php-var">$latest</span> = <span class="php-var">$m</span>[<span class="php-quote">'timestamp'</span>];
</span><span id="275" class="l"><a href="#275">275: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$m</span>[<span class="php-quote">'timestamp'</span>] &lt; <span class="php-var">$earliest</span>)
</span><span id="276" class="l"><a href="#276">276: </a>                <span class="php-var">$earliest</span> = <span class="php-var">$m</span>[<span class="php-quote">'timestamp'</span>];
</span><span id="277" class="l"><a href="#277">277: </a>            <span class="php-var">$lines</span>[<span class="php-var">$m</span>[<span class="php-quote">'timestamp'</span>]] = <span class="php-keyword1">true</span>;
</span><span id="278" class="l"><a href="#278">278: </a>            <span class="php-var">$measures</span>[<span class="php-var">$i</span>][<span class="php-quote">'import_timestamp'</span>] = <span class="php-var">$import_timestamp</span>;
</span><span id="279" class="l"><a href="#279">279: </a>            <span class="php-var">$measures</span>[<span class="php-var">$i</span>][<span class="php-quote">'original_data'</span>] = <span class="php-var">$m</span>[<span class="php-quote">'data'</span>];
</span><span id="280" class="l"><a href="#280">280: </a>            <span class="php-var">$values</span>[<span class="php-var">$m</span>[<span class="php-quote">'value_id'</span>]] = <span class="php-keyword1">true</span>;
</span><span id="281" class="l"><a href="#281">281: </a>        }
</span><span id="282" class="l"><a href="#282">282: </a>        <span class="php-keyword1">foreach</span>(<span class="php-keyword2">array_keys</span>(<span class="php-var">$values</span>) <span class="php-keyword1">as</span> <span class="php-var">$v</span>) <span class="php-comment">//Check the data for the timespan</span>
</span><span id="283" class="l"><a href="#283">283: </a>            <span class="php-var">$this</span>-&gt;Value-&gt;check_data(<span class="php-var">$v</span>, <span class="php-var">$earliest</span>, <span class="php-var">$latest</span>);
</span><span id="284" class="l"><a href="#284">284: </a>        <span class="php-comment">//debug($measures);</span>
</span><span id="285" class="l"><a href="#285">285: </a>        <span class="php-var">$this</span>-&gt;writeLog(<span class="php-quote">'imported_file'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$import_timestamp</span>, <span class="php-var">$real_filename</span>, <span class="php-keyword2">count</span>(<span class="php-var">$measures</span>), <span class="php-var">$earliest</span>, <span class="php-var">$latest</span>, <span class="php-keyword2">count</span>(<span class="php-var">$lines</span>), <span class="php-quote">'related'</span> =&gt; <span class="php-var">$input_id</span>));
</span><span id="286" class="l"><a href="#286">286: </a>        <span class="php-comment">//debug(time());</span>
</span><span id="287" class="l"><a href="#287">287: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$this</span>-&gt;Measure-&gt;saveAll(<span class="php-var">$measures</span>)){
</span><span id="288" class="l"><a href="#288">288: </a>            
</span><span id="289" class="l"><a href="#289">289: </a>        }
</span><span id="290" class="l"><a href="#290">290: </a>        <span class="php-comment">//Doppelte Eintrge lschen</span>
</span><span id="291" class="l"><a href="#291">291: </a>        <span class="php-var">$this</span>-&gt;deleteDuplicateMeasures();
</span><span id="292" class="l"><a href="#292">292: </a>        <span class="php-keyword1">return</span> <span class="php-keyword1">array</span>(<span class="php-quote">'imported'</span> =&gt; <span class="php-keyword1">true</span>, <span class="php-quote">'earliest'</span> =&gt; <span class="php-var">$earliest</span>, <span class="php-quote">'latest'</span> =&gt; <span class="php-var">$latest</span>);
</span><span id="293" class="l"><a href="#293">293: </a>    }
</span><span id="294" class="l"><a href="#294">294: </a>    
</span><span id="295" class="l"><a href="#295">295: </a>    
</span><span id="296" class="l"><a href="#296">296: </a>    <span class="php-comment">/**
</span></span><span id="297" class="l"><a href="#297">297: </a><span class="php-comment">    * Checks the data for all values in a project
</span></span><span id="298" class="l"><a href="#298">298: </a><span class="php-comment">    * @param $project_id Project id for which all measures should be checked
</span></span><span id="299" class="l"><a href="#299">299: </a><span class="php-comment">    * @param int $start Start timestamp for checking data
</span></span><span id="300" class="l"><a href="#300">300: </a><span class="php-comment">    * @param int $end End timestamp for checking data
</span></span><span id="301" class="l"><a href="#301">301: </a><span class="php-comment">    */</span>
</span><span id="302" class="l"><a href="#302">302: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> check_data(<span class="php-var">$project_id</span>, <span class="php-var">$start</span> = <span class="php-num">0</span>, <span class="php-var">$end</span> = <span class="php-num">0</span>){
</span><span id="303" class="l"><a href="#303">303: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Value'</span>);
</span><span id="304" class="l"><a href="#304">304: </a>        <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;Value-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'recursive'</span> =&gt; <span class="php-num">0</span>, <span class="php-quote">'conditions'</span> =&gt; <span class="php-quote">'Value.project_id=&quot;'</span>.<span class="php-var">$project_id</span>.<span class="php-quote">'&quot;'</span>));
</span><span id="305" class="l"><a href="#305">305: </a>        
</span><span id="306" class="l"><a href="#306">306: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$id</span> =&gt; <span class="php-var">$v</span>){
</span><span id="307" class="l"><a href="#307">307: </a>            <span class="php-var">$this</span>-&gt;Value-&gt;check_data(<span class="php-var">$id</span>, <span class="php-var">$start</span>, <span class="php-var">$end</span>);
</span><span id="308" class="l"><a href="#308">308: </a>        }
</span><span id="309" class="l"><a href="#309">309: </a>        <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'../dummy'</span>);
</span><span id="310" class="l"><a href="#310">310: </a>    }
</span><span id="311" class="l"><a href="#311">311: </a>    
</span><span id="312" class="l"><a href="#312">312: </a>    <span class="php-comment">/**
</span></span><span id="313" class="l"><a href="#313">313: </a><span class="php-comment">    * delete duplicate measures from database, duplicates have the same timestamp and value_id
</span></span><span id="314" class="l"><a href="#314">314: </a><span class="php-comment">    * @return void
</span></span><span id="315" class="l"><a href="#315">315: </a><span class="php-comment">    */</span>
</span><span id="316" class="l"><a href="#316">316: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> deleteDuplicateMeasures(){
</span><span id="317" class="l"><a href="#317">317: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Measure'</span>);
</span><span id="318" class="l"><a href="#318">318: </a>        <span class="php-comment">//Build select query for the earliest imported duplicate</span>
</span><span id="319" class="l"><a href="#319">319: </a>        <span class="php-var">$sel_query</span> = <span class="php-quote">'SELECT MIN(id) as mid FROM measures GROUP BY timestamp,value_id HAVING COUNT(*) &gt; 1'</span>;
</span><span id="320" class="l"><a href="#320">320: </a>        <span class="php-comment">/*$dmeasures = $this-&gt;Measure-&gt;query('
</span></span><span id="321" class="l"><a href="#321">321: </a><span class="php-comment">            SELECT id FROM measures WHERE id NOT in 
</span></span><span id="322" class="l"><a href="#322">322: </a><span class="php-comment">                (SELECT MAX(id) as mid FROM measures GROUP BY timestamp,value_id HAVING COUNT(*) &gt; 1)
</span></span><span id="323" class="l"><a href="#323">323: </a><span class="php-comment">            AND id NOT IN 
</span></span><span id="324" class="l"><a href="#324">324: </a><span class="php-comment">                (SELECT id FROM measures GROUP BY timestamp,value_id HAVING COUNT(*) = 1)');*/</span>
</span><span id="325" class="l"><a href="#325">325: </a>        
</span><span id="326" class="l"><a href="#326">326: </a>        <span class="php-comment">//Flag conflicts with conflict_data</span>
</span><span id="327" class="l"><a href="#327">327: </a>        <span class="php-var">$this</span>-&gt;Measure-&gt;query(<span class="php-quote">'UPDATE measures m LEFT JOIN measures c ON (m.timestamp = c.timestamp AND m.value_id = c.value_id AND m.data != c.data) SET m.conflict_data = c.data, m.state=0'</span>);
</span><span id="328" class="l"><a href="#328">328: </a>        <span class="php-var">$this</span>-&gt;Measure-&gt;cacheQueries = <span class="php-keyword1">false</span>;
</span><span id="329" class="l"><a href="#329">329: </a>        <span class="php-var">$dmeasures</span> = <span class="php-var">$this</span>-&gt;Measure-&gt;query(<span class="php-var">$sel_query</span>); <span class="php-comment">//Execute query for earliest duplicates </span>
</span><span id="330" class="l"><a href="#330">330: </a>        <span class="php-var">$c</span> = <span class="php-num">0</span>;
</span><span id="331" class="l"><a href="#331">331: </a>        <span class="php-keyword1">while</span>(<span class="php-keyword2">count</span>(<span class="php-var">$dmeasures</span>)) { <span class="php-comment">//Remove earliest duplicates until there are no duplicates</span>
</span><span id="332" class="l"><a href="#332">332: </a>            <span class="php-var">$c</span>++;
</span><span id="333" class="l"><a href="#333">333: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$dmeasures</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$dm</span>)
</span><span id="334" class="l"><a href="#334">334: </a>                <span class="php-var">$dmeasures</span>[<span class="php-var">$i</span>] = <span class="php-var">$dm</span>[<span class="php-num">0</span>][<span class="php-quote">'mid'</span>];
</span><span id="335" class="l"><a href="#335">335: </a>            
</span><span id="336" class="l"><a href="#336">336: </a>            <span class="php-var">$this</span>-&gt;Measure-&gt;query(<span class="php-quote">'DELETE FROM measures WHERE id IN ('</span>.<span class="php-keyword2">implode</span>(<span class="php-quote">','</span>,<span class="php-var">$dmeasures</span>).<span class="php-quote">')'</span>);
</span><span id="337" class="l"><a href="#337">337: </a>            <span class="php-var">$dmeasures</span> = <span class="php-var">$this</span>-&gt;Measure-&gt;query(<span class="php-var">$sel_query</span>);
</span><span id="338" class="l"><a href="#338">338: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$c</span> &gt;= <span class="php-num">1</span>) <span class="php-keyword1">break</span>;
</span><span id="339" class="l"><a href="#339">339: </a>        }
</span><span id="340" class="l"><a href="#340">340: </a>    }
</span><span id="341" class="l"><a href="#341">341: </a>    
</span><span id="342" class="l"><a href="#342">342: </a>    <span class="php-comment">/**
</span></span><span id="343" class="l"><a href="#343">343: </a><span class="php-comment">    * TODO
</span></span><span id="344" class="l"><a href="#344">344: </a><span class="php-comment">    * Parses the data from an XML file into an array of Measures to the corresponding values
</span></span><span id="345" class="l"><a href="#345">345: </a><span class="php-comment">    */</span>
</span><span id="346" class="l"><a href="#346">346: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> parseXML(<span class="php-var">$filename</span>, <span class="php-var">$values</span>){
</span><span id="347" class="l"><a href="#347">347: </a>        <span class="php-comment">//TODO</span>
</span><span id="348" class="l"><a href="#348">348: </a>    }
</span><span id="349" class="l"><a href="#349">349: </a>    
</span><span id="350" class="l"><a href="#350">350: </a>    <span class="php-comment">/**
</span></span><span id="351" class="l"><a href="#351">351: </a><span class="php-comment">    * TODO
</span></span><span id="352" class="l"><a href="#352">352: </a><span class="php-comment">    * Parses the data from a JSON file into an array of Measures to the corresponding values
</span></span><span id="353" class="l"><a href="#353">353: </a><span class="php-comment">    */</span>
</span><span id="354" class="l"><a href="#354">354: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> parseJSON(<span class="php-var">$filename</span>, <span class="php-var">$values</span>){
</span><span id="355" class="l"><a href="#355">355: </a>        <span class="php-comment">//TODO</span>
</span><span id="356" class="l"><a href="#356">356: </a>    }
</span><span id="357" class="l"><a href="#357">357: </a>    
</span><span id="358" class="l"><a href="#358">358: </a>    <span class="php-comment">/** Parses the data from a CSV file into an array of Measures to the corresponding values
</span></span><span id="359" class="l"><a href="#359">359: </a><span class="php-comment">    * @param $filename relativ filepath to the input file with the data
</span></span><span id="360" class="l"><a href="#360">360: </a><span class="php-comment">    * @param $valuesarray of fetched relevant values from the database
</span></span><span id="361" class="l"><a href="#361">361: </a><span class="php-comment">    * @param $delimiter for the CSV file
</span></span><span id="362" class="l"><a href="#362">362: </a><span class="php-comment">    * @param $data_row row in input file where data begins
</span></span><span id="363" class="l"><a href="#363">363: </a><span class="php-comment">    * @param $timestamp_pos column where the timestamp for each row is found
</span></span><span id="364" class="l"><a href="#364">364: </a><span class="php-comment">    * @param $timestamp_format PHP data format to parse the incoming timestamp time format
</span></span><span id="365" class="l"><a href="#365">365: </a><span class="php-comment">    * @return array of Measure format array('timestamp' =&gt;, 'data' =&gt;, 'value_id'=&gt;) to store to the database 
</span></span><span id="366" class="l"><a href="#366">366: </a><span class="php-comment">    */</span>
</span><span id="367" class="l"><a href="#367">367: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> parseTEXT(<span class="php-var">$filename</span>, <span class="php-var">$values</span>, <span class="php-var">$delimiter</span>, <span class="php-var">$data_row</span>, <span class="php-var">$timestamp_pos</span>, <span class="php-var">$timestamp_format</span>){
</span><span id="368" class="l"><a href="#368">368: </a>        <span class="php-var">$d</span> = <span class="php-keyword2">file</span>(<span class="php-var">$filename</span>);
</span><span id="369" class="l"><a href="#369">369: </a>        <span class="php-var">$data_row</span>--;
</span><span id="370" class="l"><a href="#370">370: </a>        <span class="php-var">$measures</span> = <span class="php-keyword1">array</span>();
</span><span id="371" class="l"><a href="#371">371: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$d</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$row</span>) {
</span><span id="372" class="l"><a href="#372">372: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$i</span> &gt;= <span class="php-var">$data_row</span>) {
</span><span id="373" class="l"><a href="#373">373: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$i</span> &gt;= <span class="php-var">$data_row</span>){
</span><span id="374" class="l"><a href="#374">374: </a>                    <span class="php-var">$limiter</span> = <span class="php-var">$delimiter</span>;
</span><span id="375" class="l"><a href="#375">375: </a>                    <span class="php-var">$cols</span> = <span class="php-keyword2">explode</span>(<span class="php-var">$limiter</span>[<span class="php-num">0</span>], <span class="php-var">$row</span>);
</span><span id="376" class="l"><a href="#376">376: </a>                    <span class="php-var">$limiter</span> = <span class="php-keyword2">substr</span>(<span class="php-var">$limiter</span>, <span class="php-num">1</span>);
</span><span id="377" class="l"><a href="#377">377: </a>                    <span class="php-var">$newRow</span> = <span class="php-keyword1">array</span>();
</span><span id="378" class="l"><a href="#378">378: </a>                    <span class="php-var">$timestamp</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$cols</span>[<span class="php-var">$timestamp_pos</span>]);
</span><span id="379" class="l"><a href="#379">379: </a>                    <span class="php-var">$useStrTime</span> = <span class="php-var">$timestamp_format</span> ? <span class="php-keyword1">false</span> : <span class="php-keyword1">true</span>;
</span><span id="380" class="l"><a href="#380">380: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$timestamp_format</span>) {
</span><span id="381" class="l"><a href="#381">381: </a>                        <span class="php-var">$date_obj</span> = DateTime::createFromFormat(<span class="php-var">$timestamp_format</span>, <span class="php-var">$timestamp</span>);
</span><span id="382" class="l"><a href="#382">382: </a>                        <span class="php-keyword1">if</span>(!<span class="php-var">$date_obj</span>)
</span><span id="383" class="l"><a href="#383">383: </a>                            <span class="php-var">$useStrTime</span> = <span class="php-keyword1">true</span>;
</span><span id="384" class="l"><a href="#384">384: </a>                        <span class="php-keyword1">else</span>
</span><span id="385" class="l"><a href="#385">385: </a>                            <span class="php-var">$timestamp</span> = <span class="php-keyword2">date_timestamp_get</span>(<span class="php-var">$date_obj</span>);
</span><span id="386" class="l"><a href="#386">386: </a>                    }
</span><span id="387" class="l"><a href="#387">387: </a>                    <span class="php-keyword1">if</span>(<span class="php-var">$useStrTime</span>) 
</span><span id="388" class="l"><a href="#388">388: </a>                        <span class="php-var">$timestamp</span> = <span class="php-keyword2">strtotime</span>(<span class="php-var">$timestamp</span>);
</span><span id="389" class="l"><a href="#389">389: </a>                    <span class="php-keyword1">if</span>(!<span class="php-var">$timestamp</span>) <span class="php-comment">//Without timestamp, no saving to the database</span>
</span><span id="390" class="l"><a href="#390">390: </a>                        <span class="php-keyword1">continue</span>;
</span><span id="391" class="l"><a href="#391">391: </a>                    <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$v</span>){
</span><span id="392" class="l"><a href="#392">392: </a>                        <span class="php-keyword1">if</span>(<span class="php-var">$v</span>[<span class="php-quote">'id'</span>] != -<span class="php-num">1</span>) { <span class="php-comment">//Don't save the timestamp (marked with -1) extra</span>
</span><span id="393" class="l"><a href="#393">393: </a>                            <span class="php-var">$m</span> = <span class="php-keyword1">array</span>(
</span><span id="394" class="l"><a href="#394">394: </a>                                <span class="php-quote">'timestamp'</span> =&gt; <span class="php-var">$timestamp</span>, 
</span><span id="395" class="l"><a href="#395">395: </a>                                <span class="php-quote">'data'</span> =&gt; <span class="php-keyword2">trim</span>(<span class="php-var">$cols</span>[<span class="php-var">$v</span>[<span class="php-quote">'InputsValue'</span>][<span class="php-quote">'path'</span>]]),  <span class="php-comment">//read column for value from input file row</span>
</span><span id="396" class="l"><a href="#396">396: </a>                                <span class="php-quote">'value_id'</span> =&gt; <span class="php-var">$v</span>[<span class="php-quote">'id'</span>]
</span><span id="397" class="l"><a href="#397">397: </a>                            );
</span><span id="398" class="l"><a href="#398">398: </a>                            <span class="php-var">$measures</span>[] = <span class="php-var">$m</span>;
</span><span id="399" class="l"><a href="#399">399: </a>                        }
</span><span id="400" class="l"><a href="#400">400: </a>                    }
</span><span id="401" class="l"><a href="#401">401: </a>                } <span class="php-keyword1">else</span> {
</span><span id="402" class="l"><a href="#402">402: </a>                    <span class="php-var">$rows</span>[<span class="php-var">$i</span>] = <span class="php-keyword2">trim</span>(<span class="php-var">$rows</span>[<span class="php-var">$i</span>]);
</span><span id="403" class="l"><a href="#403">403: </a>                }
</span><span id="404" class="l"><a href="#404">404: </a>            }
</span><span id="405" class="l"><a href="#405">405: </a>        }
</span><span id="406" class="l"><a href="#406">406: </a>        <span class="php-keyword1">return</span> <span class="php-var">$measures</span>;
</span><span id="407" class="l"><a href="#407">407: </a>    }
</span><span id="408" class="l"><a href="#408">408: </a>    
</span><span id="409" class="l"><a href="#409">409: </a>    <span class="php-comment">/**
</span></span><span id="410" class="l"><a href="#410">410: </a><span class="php-comment">    * Visualizes the data of a project. When the whole page is loading then the measures for all values are only fetched grouped by their states to show the correct buttons in the view for the data visualization and manipulation. All data for one value is loaded when the users wants to see the data by selecting a value.
</span></span><span id="411" class="l"><a href="#411">411: </a><span class="php-comment">    *
</span></span><span id="412" class="l"><a href="#412">412: </a><span class="php-comment">    * The following url parameters can be provided:
</span></span><span id="413" class="l"><a href="#413">413: </a><span class="php-comment">    *
</span></span><span id="414" class="l"><a href="#414">414: </a><span class="php-comment">    ** __start__ - start date in format d.m.Y (Default: Last 2 weeks with data)
</span></span><span id="415" class="l"><a href="#415">415: </a><span class="php-comment">    ** __end__ - end date in format d.m.Y (Last date with data)
</span></span><span id="416" class="l"><a href="#416">416: </a><span class="php-comment">    ** __value_id__ - id for if only measures for one value should be returned, this is only called so that not all measures must be loaded at the start to avoid too big data returns
</span></span><span id="417" class="l"><a href="#417">417: </a><span class="php-comment">    ** __values__ - id's of the currently selected values in the view
</span></span><span id="418" class="l"><a href="#418">418: </a><span class="php-comment">    ** __start_hour__ - hour of the day (0-23) for the start date (Default: 0)
</span></span><span id="419" class="l"><a href="#419">419: </a><span class="php-comment">    ** __start_minute__ - minute of start_hour (0-60) for the start date (Default: 0)
</span></span><span id="420" class="l"><a href="#420">420: </a><span class="php-comment">    ** __end_hour__ - hour of the day (0-23) for the end date (Default: 0)
</span></span><span id="421" class="l"><a href="#421">421: </a><span class="php-comment">    ** __end_minute__ - minute of end_hour (0-60) for the end date (Default: 0)
</span></span><span id="422" class="l"><a href="#422">422: </a><span class="php-comment">    
</span></span><span id="423" class="l"><a href="#423">423: </a><span class="php-comment">    * @param $project_id id of the project to load the data for
</span></span><span id="424" class="l"><a href="#424">424: </a><span class="php-comment">    * @return void
</span></span><span id="425" class="l"><a href="#425">425: </a><span class="php-comment">    */</span>
</span><span id="426" class="l"><a href="#426">426: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> data(<span class="php-var">$project_id</span> = <span class="php-keyword1">null</span>){
</span><span id="427" class="l"><a href="#427">427: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Measure'</span>);
</span><span id="428" class="l"><a href="#428">428: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Value'</span>);
</span><span id="429" class="l"><a href="#429">429: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Method'</span>);
</span><span id="430" class="l"><a href="#430">430: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$project_id</span>) {
</span><span id="431" class="l"><a href="#431">431: </a>            <span class="php-var">$project_id</span> = <span class="php-var">$this</span>-&gt;Session-&gt;read(<span class="php-quote">'Project'</span>);
</span><span id="432" class="l"><a href="#432">432: </a>            <span class="php-var">$project_id</span> = <span class="php-var">$project_id</span>[<span class="php-quote">'id'</span>];
</span><span id="433" class="l"><a href="#433">433: </a>        }
</span><span id="434" class="l"><a href="#434">434: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;id = <span class="php-var">$project_id</span>;
</span><span id="435" class="l"><a href="#435">435: </a>        <span class="php-var">$this</span>-&gt;Value-&gt;Behaviors-&gt;load(<span class="php-quote">'Containable'</span>);
</span><span id="436" class="l"><a href="#436">436: </a>        
</span><span id="437" class="l"><a href="#437">437: </a>        <span class="php-var">$form_values</span> = <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'values'</span>];
</span><span id="438" class="l"><a href="#438">438: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$form_values</span>)) <span class="php-var">$form_values</span> = <span class="php-keyword2">array_flip</span>(<span class="php-var">$form_values</span>); <span class="php-comment">//Exchanges all keys with their associated values in an array</span>
</span><span id="439" class="l"><a href="#439">439: </a>        
</span><span id="440" class="l"><a href="#440">440: </a>        
</span><span id="441" class="l"><a href="#441">441: </a>        <span class="php-var">$cond</span> = <span class="php-keyword1">array</span>(); <span class="php-comment">//array('Measure.value_id' =&gt; array_keys($values));</span>
</span><span id="442" class="l"><a href="#442">442: </a>        <span class="php-var">$conds</span> = <span class="php-keyword1">array</span>();
</span><span id="443" class="l"><a href="#443">443: </a>        <span class="php-var">$p</span> = <span class="php-var">$this</span>-&gt;request-&gt;query;
</span><span id="444" class="l"><a href="#444">444: </a>        <span class="php-var">$value_id</span> = <span class="php-var">$p</span>[<span class="php-quote">'value_id'</span>];
</span><span id="445" class="l"><a href="#445">445: </a>        <span class="php-var">$start</span> = <span class="php-var">$p</span>[<span class="php-quote">'start'</span>];
</span><span id="446" class="l"><a href="#446">446: </a>        <span class="php-var">$end</span> = <span class="php-var">$p</span>[<span class="php-quote">'end'</span>];
</span><span id="447" class="l"><a href="#447">447: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$start</span>) {
</span><span id="448" class="l"><a href="#448">448: </a>            <span class="php-var">$start</span> = <span class="php-keyword2">strtotime</span>(<span class="php-var">$start</span>.<span class="php-quote">', '</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$p</span>[<span class="php-quote">'start_hour'</span>]).<span class="php-quote">':'</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$p</span>[<span class="php-quote">'start_minute'</span>]));
</span><span id="449" class="l"><a href="#449">449: </a>            <span class="php-var">$end</span> = <span class="php-var">$end</span> ? <span class="php-keyword2">strtotime</span>(<span class="php-var">$end</span>.<span class="php-quote">', '</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$p</span>[<span class="php-quote">'end_hour'</span>]).<span class="php-quote">':'</span>.<span class="php-keyword2">intval</span>(<span class="php-var">$p</span>[<span class="php-quote">'end_minute'</span>])) : <span class="php-keyword2">strtotime</span>(<span class="php-quote">'00:00'</span>);
</span><span id="450" class="l"><a href="#450">450: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$start</span> &gt; <span class="php-var">$end</span>) {
</span><span id="451" class="l"><a href="#451">451: </a>                <span class="php-var">$h</span> = <span class="php-var">$start</span>;
</span><span id="452" class="l"><a href="#452">452: </a>                <span class="php-var">$start</span> = <span class="php-var">$end</span>;
</span><span id="453" class="l"><a href="#453">453: </a>                <span class="php-var">$end</span> = <span class="php-var">$h</span>;
</span><span id="454" class="l"><a href="#454">454: </a>                <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'start'</span>] = <span class="php-keyword2">date</span>(<span class="php-quote">'d.m.Y'</span>, <span class="php-var">$start</span>);
</span><span id="455" class="l"><a href="#455">455: </a>                <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'end'</span>] = <span class="php-keyword2">date</span>(<span class="php-quote">'d.m.Y'</span>, <span class="php-var">$end</span>);
</span><span id="456" class="l"><a href="#456">456: </a>            }
</span><span id="457" class="l"><a href="#457">457: </a>            <span class="php-var">$conds</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'Measure.timestamp &gt;'</span> =&gt; <span class="php-var">$start</span>, <span class="php-quote">'Measure.timestamp &lt;'</span> =&gt; <span class="php-var">$end</span>);
</span><span id="458" class="l"><a href="#458">458: </a>        } <span class="php-keyword1">else</span> {
</span><span id="459" class="l"><a href="#459">459: </a>            <span class="php-var">$value_ids</span> = <span class="php-var">$this</span>-&gt;Project-&gt;Value-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'project_id'</span> =&gt; <span class="php-var">$project_id</span>)));
</span><span id="460" class="l"><a href="#460">460: </a>            <span class="php-var">$latest</span> = <span class="php-var">$this</span>-&gt;Project-&gt;Value-&gt;Measure-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'recursive'</span> =&gt; <span class="php-num">0</span>, <span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'value_id'</span> =&gt; <span class="php-keyword2">array_keys</span>(<span class="php-var">$value_ids</span>)), <span class="php-quote">'order'</span> =&gt; <span class="php-quote">'Measure.timestamp DESC'</span>));
</span><span id="461" class="l"><a href="#461">461: </a>            <span class="php-var">$latest</span> = <span class="php-var">$latest</span>[<span class="php-quote">'Measure'</span>][<span class="php-quote">'timestamp'</span>];
</span><span id="462" class="l"><a href="#462">462: </a>            <span class="php-var">$start</span> = <span class="php-keyword2">strtotime</span>(<span class="php-quote">'00:00 -2 weeks'</span>, <span class="php-var">$latest</span>);
</span><span id="463" class="l"><a href="#463">463: </a>            <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'start'</span>] = <span class="php-keyword2">date</span>(<span class="php-quote">'d.m.Y'</span>, <span class="php-var">$start</span>);
</span><span id="464" class="l"><a href="#464">464: </a>            <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'start_hour'</span>] = <span class="php-quote">'00'</span>;
</span><span id="465" class="l"><a href="#465">465: </a>            <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'start_minute'</span>] = <span class="php-quote">'00'</span>;
</span><span id="466" class="l"><a href="#466">466: </a>            <span class="php-var">$end</span> = <span class="php-keyword2">strtotime</span>(<span class="php-quote">'00:00'</span>, <span class="php-var">$latest</span>);
</span><span id="467" class="l"><a href="#467">467: </a>            <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'end'</span>] = <span class="php-keyword2">date</span>(<span class="php-quote">'d.m.Y'</span>, <span class="php-var">$end</span>);
</span><span id="468" class="l"><a href="#468">468: </a>            <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'end_hour'</span>] = <span class="php-quote">'00'</span>;
</span><span id="469" class="l"><a href="#469">469: </a>            <span class="php-var">$this</span>-&gt;request-&gt;query[<span class="php-quote">'end_minute'</span>] = <span class="php-quote">'00'</span>;
</span><span id="470" class="l"><a href="#470">470: </a>            <span class="php-var">$conds</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'Measure.timestamp &gt;'</span> =&gt; <span class="php-var">$start</span>, <span class="php-quote">'Measure.timestamp &lt;'</span> =&gt; <span class="php-var">$end</span>);
</span><span id="471" class="l"><a href="#471">471: </a>        }
</span><span id="472" class="l"><a href="#472">472: </a>        <span class="php-var">$conds</span> = <span class="php-keyword2">array_merge</span>(<span class="php-var">$cond</span>, <span class="php-var">$conds</span>);
</span><span id="473" class="l"><a href="#473">473: </a>        <span class="php-var">$vconds</span> =  <span class="php-keyword1">array</span>(<span class="php-quote">'Value.project_id'</span> =&gt; <span class="php-var">$project_id</span>);
</span><span id="474" class="l"><a href="#474">474: </a>        <span class="php-var">$limit</span> = <span class="php-num">0</span>;
</span><span id="475" class="l"><a href="#475">475: </a>        <span class="php-var">$group</span> = <span class="php-quote">'Measure.state'</span>;
</span><span id="476" class="l"><a href="#476">476: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$value_id</span>) {
</span><span id="477" class="l"><a href="#477">477: </a>            <span class="php-var">$vconds</span>[<span class="php-quote">'Value.id'</span>] = <span class="php-var">$value_id</span>;
</span><span id="478" class="l"><a href="#478">478: </a>            <span class="php-var">$limit</span> = <span class="php-num">0</span>;
</span><span id="479" class="l"><a href="#479">479: </a>            <span class="php-var">$group</span> = <span class="php-keyword1">null</span>;
</span><span id="480" class="l"><a href="#480">480: </a>        }
</span><span id="481" class="l"><a href="#481">481: </a>        <span class="php-keyword1">try</span> {
</span><span id="482" class="l"><a href="#482">482: </a>            <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;Value-&gt;find(<span class="php-quote">'all'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-var">$vconds</span>, <span class="php-quote">'order'</span> =&gt; <span class="php-quote">'Value.name ASC'</span>, <span class="php-quote">'contain'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Unit'</span>)));
</span><span id="483" class="l"><a href="#483">483: </a>            
</span><span id="484" class="l"><a href="#484">484: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$v</span>){
</span><span id="485" class="l"><a href="#485">485: </a>                <span class="php-var">$measures</span> = <span class="php-var">$this</span>-&gt;Value-&gt;Measure-&gt;find(<span class="php-quote">'all'</span>, <span class="php-keyword1">array</span>(
</span><span id="486" class="l"><a href="#486">486: </a>                    <span class="php-quote">'fields'</span> =&gt; <span class="php-quote">'Measure.data,Measure.timestamp,Measure.state'</span>, 
</span><span id="487" class="l"><a href="#487">487: </a>                    <span class="php-quote">'recursive'</span> =&gt; <span class="php-num">0</span>, 
</span><span id="488" class="l"><a href="#488">488: </a>                    <span class="php-quote">'order'</span> =&gt; <span class="php-quote">'Measure.timestamp ASC'</span>, 
</span><span id="489" class="l"><a href="#489">489: </a>                    <span class="php-quote">'limit'</span> =&gt; <span class="php-var">$limit</span>, 
</span><span id="490" class="l"><a href="#490">490: </a>                    <span class="php-quote">'group'</span> =&gt; <span class="php-var">$group</span>,
</span><span id="491" class="l"><a href="#491">491: </a>                    <span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword2">array_merge</span>(<span class="php-var">$conds</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'Measure.value_id'</span> =&gt; <span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'id'</span>])))
</span><span id="492" class="l"><a href="#492">492: </a>                );
</span><span id="493" class="l"><a href="#493">493: </a>                <span class="php-var">$measures</span> = Set::<span class="php-keyword2">extract</span>(<span class="php-var">$measures</span>, <span class="php-quote">'{n}.Measure'</span>);
</span><span id="494" class="l"><a href="#494">494: </a>                <span class="php-comment">//debug($measures);</span>
</span><span id="495" class="l"><a href="#495">495: </a>                <span class="php-var">$values</span>[<span class="php-var">$i</span>][<span class="php-quote">'Measure'</span>] = <span class="php-var">$measures</span>;
</span><span id="496" class="l"><a href="#496">496: </a>            }
</span><span id="497" class="l"><a href="#497">497: </a>        } <span class="php-keyword1">catch</span> (Exception <span class="php-var">$e</span>){
</span><span id="498" class="l"><a href="#498">498: </a>            <span class="php-var">$values</span> = <span class="php-keyword1">array</span>();
</span><span id="499" class="l"><a href="#499">499: </a>            <span class="php-var">$this</span>-&gt;er(<span class="php-var">$e</span>);
</span><span id="500" class="l"><a href="#500">500: </a>        }
</span><span id="501" class="l"><a href="#501">501: </a>        <span class="php-var">$values</span> = Set::combine(<span class="php-var">$values</span>, <span class="php-quote">'{n}.Value.id'</span>, <span class="php-quote">'{n}'</span>); <span class="php-comment">//set the value id as the key for each value</span>
</span><span id="502" class="l"><a href="#502">502: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$v</span>){
</span><span id="503" class="l"><a href="#503">503: </a>            <span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>] = <span class="php-var">$this</span>-&gt;Measure-&gt;short_keys(<span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>]); <span class="php-comment">//shorter names for less payload when sending data to the browser</span>
</span><span id="504" class="l"><a href="#504">504: </a>            
</span><span id="505" class="l"><a href="#505">505: </a>            <span class="php-var">$values</span>[<span class="php-var">$i</span>] = <span class="php-var">$v</span>;
</span><span id="506" class="l"><a href="#506">506: </a>        }
</span><span id="507" class="l"><a href="#507">507: </a>        
</span><span id="508" class="l"><a href="#508">508: </a>        <span class="php-comment">//If just requesting one value don't prepare unnecessary variables for the view</span>
</span><span id="509" class="l"><a href="#509">509: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$value_id</span>) { 
</span><span id="510" class="l"><a href="#510">510: </a>            <span class="php-comment">//Get list of available methods </span>
</span><span id="511" class="l"><a href="#511">511: </a>            <span class="php-var">$methods</span> = <span class="php-var">$this</span>-&gt;Method-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'order'</span> =&gt; <span class="php-quote">'name'</span>, <span class="php-quote">'conditions'</span> =&gt; <span class="php-quote">'ISNULL(project_id) OR project_id = 0 OR project_id='</span>.<span class="php-var">$project_id</span>));
</span><span id="512" class="l"><a href="#512">512: </a>            
</span><span id="513" class="l"><a href="#513">513: </a>            <span class="php-var">$unit_prefixes</span> = console::<span class="php-var">$unit_prefixes</span>;
</span><span id="514" class="l"><a href="#514">514: </a>            <span class="php-var">$project</span> = <span class="php-var">$this</span>-&gt;Project-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$project_id</span>);
</span><span id="515" class="l"><a href="#515">515: </a>            <span class="php-var">$this</span>-&gt;project_set_session(<span class="php-var">$project</span>);
</span><span id="516" class="l"><a href="#516">516: </a>            <span class="php-var">$manipulates</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'-1'</span> =&gt; __(<span class="php-quote">'that are flagged'</span>), <span class="php-num">0</span> =&gt; __(<span class="php-quote">'under'</span>), <span class="php-num">1</span> =&gt; __(<span class="php-quote">&quot;over&quot;</span>));
</span><span id="517" class="l"><a href="#517">517: </a>            <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'project'</span>, <span class="php-quote">'project_id'</span>, <span class="php-quote">'values'</span>, <span class="php-quote">'imports'</span>, <span class="php-quote">'methods'</span>, <span class="php-quote">'unit_prefixes'</span>, <span class="php-quote">'import_timestamp'</span>, <span class="php-quote">'form_values'</span>, <span class="php-quote">'start'</span>, <span class="php-quote">'end'</span>, <span class="php-quote">'manipulates'</span>));
</span><span id="518" class="l"><a href="#518">518: </a>        } <span class="php-keyword1">else</span> {
</span><span id="519" class="l"><a href="#519">519: </a>            <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'values'</span>));
</span><span id="520" class="l"><a href="#520">520: </a>            <span class="php-var">$this</span>-&gt;layout = <span class="php-quote">'json'</span>;
</span><span id="521" class="l"><a href="#521">521: </a>        }
</span><span id="522" class="l"><a href="#522">522: </a>    }
</span><span id="523" class="l"><a href="#523">523: </a>    
</span><span id="524" class="l"><a href="#524">524: </a>    <span class="php-comment">/**
</span></span><span id="525" class="l"><a href="#525">525: </a><span class="php-comment">    * Stores data from current upload with name import_file into the webroot/uploads folder. 
</span></span><span id="526" class="l"><a href="#526">526: </a><span class="php-comment">    * @param $url If the param URL is provided it get the data from a remote file. 
</span></span><span id="527" class="l"><a href="#527">527: </a><span class="php-comment">    * @param $page_container The page_container parameter can be a regex or a jQuery selector to parse the actual content out of a container
</span></span><span id="528" class="l"><a href="#528">528: </a><span class="php-comment">    * @return string $filename of the stored file, set $this-&gt;data['import_file'] = $filename
</span></span><span id="529" class="l"><a href="#529">529: </a><span class="php-comment">    */</span>
</span><span id="530" class="l"><a href="#530">530: </a>    <span class="php-keyword1">function</span> store_data(<span class="php-var">$input_id</span>, <span class="php-var">$url</span> = <span class="php-keyword1">false</span>, <span class="php-var">$page_container</span> = <span class="php-keyword1">false</span>) { 
</span><span id="531" class="l"><a href="#531">531: </a>        <span class="php-comment">// Initialize filename-variable</span>
</span><span id="532" class="l"><a href="#532">532: </a>        <span class="php-var">$filename</span> = <span class="php-keyword1">null</span>;
</span><span id="533" class="l"><a href="#533">533: </a>        <span class="php-comment">//debug($this-&gt;request-&gt;data['import_file']);</span>
</span><span id="534" class="l"><a href="#534">534: </a>        <span class="php-var">$is_upload</span> = !<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'import_file'</span>][<span class="php-quote">'tmp_name'</span>]) &amp;&amp; <span class="php-keyword2">is_uploaded_file</span>(<span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'import_file'</span>][<span class="php-quote">'tmp_name'</span>]);
</span><span id="535" class="l"><a href="#535">535: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$is_upload</span>) {
</span><span id="536" class="l"><a href="#536">536: </a>            <span class="php-var">$filename</span> = <span class="php-keyword2">basename</span>(<span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'import_file'</span>][<span class="php-quote">'name'</span>]); 
</span><span id="537" class="l"><a href="#537">537: </a>        } <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$url</span>) {
</span><span id="538" class="l"><a href="#538">538: </a>            <span class="php-var">$filename</span> = <span class="php-keyword2">basename</span>(<span class="php-var">$url</span>); 
</span><span id="539" class="l"><a href="#539">539: </a>        }
</span><span id="540" class="l"><a href="#540">540: </a>        
</span><span id="541" class="l"><a href="#541">541: </a>        <span class="php-var">$filename</span> = <span class="php-quote">'import_'</span>.<span class="php-keyword2">date</span>(<span class="php-quote">'YmdHis'</span>).<span class="php-quote">'_'</span>.<span class="php-var">$input_id</span>.<span class="php-quote">'.txt'</span>;
</span><span id="542" class="l"><a href="#542">542: </a>        <span class="php-var">$filepath</span> = DS . <span class="php-quote">'uploads'</span> . DS . <span class="php-var">$filename</span>;
</span><span id="543" class="l"><a href="#543">543: </a>        <span class="php-var">$filename</span> = <span class="php-quote">'/'</span> . <span class="php-quote">'uploads'</span> . <span class="php-quote">'/'</span> . <span class="php-var">$filename</span>;
</span><span id="544" class="l"><a href="#544">544: </a>        
</span><span id="545" class="l"><a href="#545">545: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$is_upload</span>) {
</span><span id="546" class="l"><a href="#546">546: </a>            <span class="php-comment">//$c = file_get_contents($this-&gt;data['import_file']['tmp_name']);</span>
</span><span id="547" class="l"><a href="#547">547: </a>            <span class="php-keyword2">move_uploaded_file</span>(
</span><span id="548" class="l"><a href="#548">548: </a>                <span class="php-var">$this</span>-&gt;data[<span class="php-quote">'import_file'</span>][<span class="php-quote">'tmp_name'</span>],
</span><span id="549" class="l"><a href="#549">549: </a>                WWW_ROOT . <span class="php-var">$filepath</span>
</span><span id="550" class="l"><a href="#550">550: </a>            );
</span><span id="551" class="l"><a href="#551">551: </a>            <span class="php-var">$hash</span> = <span class="php-keyword2">hash_file</span>(<span class="php-quote">'md5'</span>, WWW_ROOT . <span class="php-var">$filepath</span>);
</span><span id="552" class="l"><a href="#552">552: </a>            <span class="php-var">$this</span>-&gt;writeLog(<span class="php-quote">'uploaded_file'</span>, <span class="php-keyword1">array</span>(<span class="php-keyword1">false</span>, <span class="php-var">$filename</span>, <span class="php-var">$hash</span>, <span class="php-quote">'related'</span> =&gt; <span class="php-var">$input_id</span>));
</span><span id="553" class="l"><a href="#553">553: </a>        } <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$url</span>) {
</span><span id="554" class="l"><a href="#554">554: </a>            <span class="php-var">$c</span> = <span class="php-keyword2">file_get_contents</span>(<span class="php-var">$url</span>);
</span><span id="555" class="l"><a href="#555">555: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$page_container</span>) {
</span><span id="556" class="l"><a href="#556">556: </a>                App::import(<span class="php-quote">'Vendor'</span>, <span class="php-quote">'phpQuery'</span>);
</span><span id="557" class="l"><a href="#557">557: </a>                pq(<span class="php-quote">'load'</span>, <span class="php-var">$c</span>);
</span><span id="558" class="l"><a href="#558">558: </a>                <span class="php-comment">//debug($c);</span>
</span><span id="559" class="l"><a href="#559">559: </a>                <span class="php-keyword1">if</span>(pq(<span class="php-var">$page_container</span>)-&gt;length == <span class="php-num">1</span>)
</span><span id="560" class="l"><a href="#560">560: </a>                    <span class="php-var">$c</span> = pq(<span class="php-var">$page_container</span>)-&gt;html();
</span><span id="561" class="l"><a href="#561">561: </a>                <span class="php-keyword1">else</span> {
</span><span id="562" class="l"><a href="#562">562: </a>                }
</span><span id="563" class="l"><a href="#563">563: </a>            }
</span><span id="564" class="l"><a href="#564">564: </a>            <span class="php-var">$c</span> = <span class="php-keyword2">utf8_encode</span>(<span class="php-keyword2">trim</span>(<span class="php-var">$c</span>));
</span><span id="565" class="l"><a href="#565">565: </a>            <span class="php-keyword2">file_put_contents</span>(WWW_ROOT . <span class="php-var">$filepath</span>, <span class="php-var">$c</span>);
</span><span id="566" class="l"><a href="#566">566: </a>            <span class="php-var">$hash</span> = <span class="php-keyword2">md5</span>(<span class="php-var">$c</span>);
</span><span id="567" class="l"><a href="#567">567: </a>            <span class="php-var">$this</span>-&gt;writeLog(<span class="php-quote">'imported_url'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$url</span>, <span class="php-var">$filename</span>, <span class="php-var">$hash</span>, <span class="php-quote">'related'</span> =&gt; <span class="php-var">$input_id</span>));
</span><span id="568" class="l"><a href="#568">568: </a>        }
</span><span id="569" class="l"><a href="#569">569: </a>        
</span><span id="570" class="l"><a href="#570">570: </a>        <span class="php-comment">// Set the file-name only to save in the database</span>
</span><span id="571" class="l"><a href="#571">571: </a>        <span class="php-var">$this</span>-&gt;data[<span class="php-quote">'import_file'</span>] = <span class="php-var">$filename</span>;
</span><span id="572" class="l"><a href="#572">572: </a>        <span class="php-keyword1">return</span> <span class="php-var">$filename</span>;
</span><span id="573" class="l"><a href="#573">573: </a>    }
</span><span id="574" class="l"><a href="#574">574: </a>    
</span><span id="575" class="l"><a href="#575">575: </a>    <span class="php-comment">/**
</span></span><span id="576" class="l"><a href="#576">576: </a><span class="php-comment">    * Calculates Measures for all Values by its predefined methods in a project
</span></span><span id="577" class="l"><a href="#577">577: </a><span class="php-comment">    * @param $project_id id of the project
</span></span><span id="578" class="l"><a href="#578">578: </a><span class="php-comment">    * @param array $params[start-&gt;int, end-&gt;int] must contain 'start' and 'end' timestamp or must be provided in the $_GET parameters
</span></span><span id="579" class="l"><a href="#579">579: </a><span class="php-comment">    */</span>
</span><span id="580" class="l"><a href="#580">580: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> calculate_values(<span class="php-var">$project_id</span>, <span class="php-var">$params</span> = <span class="php-keyword1">false</span>){
</span><span id="581" class="l"><a href="#581">581: </a>        <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;Project-&gt;Value-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-quote">'project_id=&quot;'</span>.<span class="php-var">$project_id</span>.<span class="php-quote">'&quot;'</span>));
</span><span id="582" class="l"><a href="#582">582: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$value_id</span> =&gt; <span class="php-var">$name</span>) {
</span><span id="583" class="l"><a href="#583">583: </a>            <span class="php-var">$this</span>-&gt;calculate_value(<span class="php-var">$value_id</span>, <span class="php-var">$params</span>);
</span><span id="584" class="l"><a href="#584">584: </a>        }
</span><span id="585" class="l"><a href="#585">585: </a>    }
</span><span id="586" class="l"><a href="#586">586: </a>    
</span><span id="587" class="l"><a href="#587">587: </a>    <span class="php-comment">/**
</span></span><span id="588" class="l"><a href="#588">588: </a><span class="php-comment">    * Calculates Measures for a Value by its predefined method
</span></span><span id="589" class="l"><a href="#589">589: </a><span class="php-comment">    * The params must contain:
</span></span><span id="590" class="l"><a href="#590">590: </a><span class="php-comment">    *
</span></span><span id="591" class="l"><a href="#591">591: </a><span class="php-comment">    ** __start__ - Start timestamp
</span></span><span id="592" class="l"><a href="#592">592: </a><span class="php-comment">    ** __end__ - End timestamp
</span></span><span id="593" class="l"><a href="#593">593: </a><span class="php-comment">    *
</span></span><span id="594" class="l"><a href="#594">594: </a><span class="php-comment">    * @param value_id id of the value
</span></span><span id="595" class="l"><a href="#595">595: </a><span class="php-comment">    * @param $params array or the params for the execution, are fetched from the query string or the value
</span></span><span id="596" class="l"><a href="#596">596: </a><span class="php-comment">    * @return void
</span></span><span id="597" class="l"><a href="#597">597: </a><span class="php-comment">    */</span>
</span><span id="598" class="l"><a href="#598">598: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> calculate_value(<span class="php-var">$value_id</span>, <span class="php-var">$params</span> = <span class="php-keyword1">false</span>){
</span><span id="599" class="l"><a href="#599">599: </a>        <span class="php-var">$this</span>-&gt;layout = <span class="php-quote">'json'</span>;
</span><span id="600" class="l"><a href="#600">600: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Value'</span>);
</span><span id="601" class="l"><a href="#601">601: </a>        <span class="php-keyword1">if</span>( !<span class="php-var">$params</span> )
</span><span id="602" class="l"><a href="#602">602: </a>            <span class="php-var">$params</span> = <span class="php-var">$this</span>-&gt;request-&gt;query; 
</span><span id="603" class="l"><a href="#603">603: </a>        <span class="php-var">$this</span>-&gt;Value-&gt;id = <span class="php-var">$value_id</span>;
</span><span id="604" class="l"><a href="#604">604: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Value-&gt;exists()) {
</span><span id="605" class="l"><a href="#605">605: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid value'</span>));
</span><span id="606" class="l"><a href="#606">606: </a>        }
</span><span id="607" class="l"><a href="#607">607: </a>        <span class="php-var">$v</span> = <span class="php-var">$this</span>-&gt;Value-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$value_id</span>);
</span><span id="608" class="l"><a href="#608">608: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'method_id'</span>]) {
</span><span id="609" class="l"><a href="#609">609: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'No Method for this Value defined.'</span>));
</span><span id="610" class="l"><a href="#610">610: </a>            <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'../dummy'</span>);
</span><span id="611" class="l"><a href="#611">611: </a>            <span class="php-keyword1">return</span>;
</span><span id="612" class="l"><a href="#612">612: </a>        }
</span><span id="613" class="l"><a href="#613">613: </a>        <span class="php-var">$start</span> = console::makeTimestamp(<span class="php-var">$params</span>[<span class="php-quote">'start'</span>]);
</span><span id="614" class="l"><a href="#614">614: </a>        <span class="php-var">$end</span> = console::makeTimestamp(<span class="php-var">$params</span>[<span class="php-quote">'end'</span>]);
</span><span id="615" class="l"><a href="#615">615: </a>        <span class="php-var">$project_id</span> = <span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'project_id'</span>];
</span><span id="616" class="l"><a href="#616">616: </a>        <span class="php-var">$vparams</span> = <span class="php-keyword2">json_decode</span>(<span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'method_params'</span>], <span class="php-keyword1">true</span>);
</span><span id="617" class="l"><a href="#617">617: </a>        <span class="php-var">$params</span> = <span class="php-keyword2">array_merge</span>(<span class="php-var">$params</span>, <span class="php-var">$vparams</span>);
</span><span id="618" class="l"><a href="#618">618: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Method'</span>);
</span><span id="619" class="l"><a href="#619">619: </a>        <span class="php-var">$result</span> = <span class="php-var">$this</span>-&gt;Method-&gt;execute(<span class="php-var">$v</span>[<span class="php-quote">'Method'</span>][<span class="php-quote">'id'</span>], <span class="php-var">$params</span>, <span class="php-var">$start</span>, <span class="php-var">$end</span>, <span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'interval_count'</span>], <span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'interval_type'</span>], <span class="php-keyword1">true</span>);
</span><span id="620" class="l"><a href="#620">620: </a>        <span class="php-keyword1">if</span>(<span class="php-keyword2">is_array</span>(<span class="php-var">$result</span>)){
</span><span id="621" class="l"><a href="#621">621: </a>            <span class="php-var">$import_timestamp</span> = <span class="php-keyword2">time</span>();
</span><span id="622" class="l"><a href="#622">622: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$result</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$r</span>){
</span><span id="623" class="l"><a href="#623">623: </a>                <span class="php-var">$result</span>[<span class="php-var">$i</span>][<span class="php-quote">'import_timestamp'</span>] = <span class="php-var">$import_timestamp</span>;
</span><span id="624" class="l"><a href="#624">624: </a>                <span class="php-var">$result</span>[<span class="php-var">$i</span>][<span class="php-quote">'value_id'</span>] = <span class="php-var">$value_id</span>;
</span><span id="625" class="l"><a href="#625">625: </a>                <span class="php-var">$result</span>[<span class="php-var">$i</span>][<span class="php-quote">'original_data'</span>] = <span class="php-var">$r</span>[<span class="php-quote">'data'</span>];
</span><span id="626" class="l"><a href="#626">626: </a>            }
</span><span id="627" class="l"><a href="#627">627: </a>            <span class="php-comment">//debug($result);</span>
</span><span id="628" class="l"><a href="#628">628: </a>            <span class="php-var">$this</span>-&gt;Value-&gt;Measure-&gt;saveAll(<span class="php-var">$result</span>);
</span><span id="629" class="l"><a href="#629">629: </a>            <span class="php-var">$this</span>-&gt;deleteDuplicateMeasures();
</span><span id="630" class="l"><a href="#630">630: </a>        } <span class="php-keyword1">else</span> {
</span><span id="631" class="l"><a href="#631">631: </a>            
</span><span id="632" class="l"><a href="#632">632: </a>        }
</span><span id="633" class="l"><a href="#633">633: </a>        <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'../dummy'</span>);
</span><span id="634" class="l"><a href="#634">634: </a>    }
</span><span id="635" class="l"><a href="#635">635: </a>    
</span><span id="636" class="l"><a href="#636">636: </a>    <span class="php-comment">/**
</span></span><span id="637" class="l"><a href="#637">637: </a><span class="php-comment">    * Exports data in a given format. The function is implemented to export the data in CSV format and must be changed to enable other formats
</span></span><span id="638" class="l"><a href="#638">638: </a><span class="php-comment">    *
</span></span><span id="639" class="l"><a href="#639">639: </a><span class="php-comment">    * The following url parameters can or must be provided:
</span></span><span id="640" class="l"><a href="#640">640: </a><span class="php-comment">    *
</span></span><span id="641" class="l"><a href="#641">641: </a><span class="php-comment">    ** __start__ - Startdate day.month.year,hour:minute:second
</span></span><span id="642" class="l"><a href="#642">642: </a><span class="php-comment">    ** __end__ - Enddate day.month.year,hour:minute:second
</span></span><span id="643" class="l"><a href="#643">643: </a><span class="php-comment">    ** __api_key__ - Export api key to get access to the api, it can be one of the project related keys generated for an export
</span></span><span id="644" class="l"><a href="#644">644: </a><span class="php-comment">    ** __format__ - Possible values: csv, sensorML, xml, json (Optional, default: csv) //Until now only csv is supported (Remove this notice if format supports were added)
</span></span><span id="645" class="l"><a href="#645">645: </a><span class="php-comment">    ** __values__ - Comma seperated list of value ids to be exported (Optional, default is empty and returns all values in project)
</span></span><span id="646" class="l"><a href="#646">646: </a><span class="php-comment">    ** __debug__ - 1 returns data in user readable format (Optional)
</span></span><span id="647" class="l"><a href="#647">647: </a><span class="php-comment">    ** __dateformat__ - One or more PHP date formats seperated by comma (Optional)
</span></span><span id="648" class="l"><a href="#648">648: </a><span class="php-comment">    ** __download__ - 1 creates a file with the export name which is directly sent to the browser for download (Optional, Default: 0)
</span></span><span id="649" class="l"><a href="#649">649: </a><span class="php-comment">    ** __states__ - 1 exports the state for every measure (Optional, Default: 0)
</span></span><span id="650" class="l"><a href="#650">650: </a><span class="php-comment">    ** __deleted__ - 1 exports the state for every measure (Optional, Default: 0)
</span></span><span id="651" class="l"><a href="#651">651: </a><span class="php-comment">    
</span></span><span id="652" class="l"><a href="#652">652: </a><span class="php-comment">    @param int $id Project ID
</span></span><span id="653" class="l"><a href="#653">653: </a><span class="php-comment">    */</span>
</span><span id="654" class="l"><a href="#654">654: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> export(<span class="php-var">$id</span>) {
</span><span id="655" class="l"><a href="#655">655: </a>        <span class="php-var">$project_id</span> = <span class="php-var">$id</span>;
</span><span id="656" class="l"><a href="#656">656: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Value'</span>);
</span><span id="657" class="l"><a href="#657">657: </a>        <span class="php-var">$p</span> = <span class="php-var">$this</span>-&gt;p;
</span><span id="658" class="l"><a href="#658">658: </a>        <span class="php-var">$start</span> = <span class="php-keyword2">strtotime</span>(<span class="php-var">$p</span>[<span class="php-quote">'start'</span>]);
</span><span id="659" class="l"><a href="#659">659: </a>        <span class="php-var">$end</span> = <span class="php-keyword2">strtotime</span>(<span class="php-var">$p</span>[<span class="php-quote">'end'</span>]);
</span><span id="660" class="l"><a href="#660">660: </a>        <span class="php-var">$this</span>-&gt;layout = <span class="php-quote">'template'</span>;
</span><span id="661" class="l"><a href="#661">661: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'Export'</span>);
</span><span id="662" class="l"><a href="#662">662: </a>        <span class="php-var">$export</span> = <span class="php-var">$this</span>-&gt;Export-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'project_id'</span> =&gt; <span class="php-var">$id</span>, <span class="php-quote">'auth'</span> =&gt; <span class="php-var">$p</span>[<span class="php-quote">'api_key'</span>]))); <span class="php-comment">//Find an export to verify rights to export</span>
</span><span id="663" class="l"><a href="#663">663: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$export</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;authorizedProject(<span class="php-var">$project_id</span>, console::<span class="php-var">$contributorState</span>, <span class="php-keyword1">false</span>)) {
</span><span id="664" class="l"><a href="#664">664: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'The provided api key is not correct or you have not enough rights.'</span>));
</span><span id="665" class="l"><a href="#665">665: </a>            <span class="php-keyword1">return</span>;
</span><span id="666" class="l"><a href="#666">666: </a>        }
</span><span id="667" class="l"><a href="#667">667: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$start</span>) {
</span><span id="668" class="l"><a href="#668">668: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'A starttime must be provided.'</span>));
</span><span id="669" class="l"><a href="#669">669: </a>            <span class="php-keyword1">return</span>;
</span><span id="670" class="l"><a href="#670">670: </a>        }
</span><span id="671" class="l"><a href="#671">671: </a>        <span class="php-comment">//$id noch als parameter</span>
</span><span id="672" class="l"><a href="#672">672: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$end</span>) {
</span><span id="673" class="l"><a href="#673">673: </a>            <span class="php-var">$end</span> = <span class="php-keyword2">strtotime</span>(<span class="php-quote">'tomorrow 00:00'</span>, <span class="php-var">$start</span>);
</span><span id="674" class="l"><a href="#674">674: </a>        }
</span><span id="675" class="l"><a href="#675">675: </a>        <span class="php-var">$debug</span> = <span class="php-var">$p</span>[<span class="php-quote">'debug'</span>];
</span><span id="676" class="l"><a href="#676">676: </a>        <span class="php-var">$format</span> = <span class="php-var">$p</span>[<span class="php-quote">'format'</span>];
</span><span id="677" class="l"><a href="#677">677: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$format</span>) 
</span><span id="678" class="l"><a href="#678">678: </a>            <span class="php-var">$format</span> = <span class="php-quote">'csv'</span>;
</span><span id="679" class="l"><a href="#679">679: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$debug</span>) {
</span><span id="680" class="l"><a href="#680">680: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$format</span> == <span class="php-quote">'json'</span>) <span class="php-var">$hFormat</span> = <span class="php-quote">'text/javascript'</span>;
</span><span id="681" class="l"><a href="#681">681: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$format</span> == <span class="php-quote">'csv'</span>) <span class="php-var">$hFormat</span> = <span class="php-var">$p</span>[<span class="php-quote">'download'</span>] ? <span class="php-quote">'application/vnd.ms-excel'</span> : <span class="php-quote">'text/javascript'</span>;
</span><span id="682" class="l"><a href="#682">682: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$p</span>[<span class="php-quote">'download'</span>]) { <span class="php-comment">//If download, create filename and set content types</span>
</span><span id="683" class="l"><a href="#683">683: </a>                <span class="php-var">$filename</span> = <span class="php-var">$export</span>[<span class="php-quote">'Export'</span>][<span class="php-quote">'name'</span>].<span class="php-quote">'_'</span>.<span class="php-keyword2">date</span>(<span class="php-quote">'Y-m-d'</span>, <span class="php-var">$start</span>).<span class="php-quote">'_'</span>.<span class="php-keyword2">date</span>(<span class="php-quote">'Y-m-d'</span>, <span class="php-var">$end</span>);
</span><span id="684" class="l"><a href="#684">684: </a>                <span class="php-var">$this</span>-&gt;response-&gt;type(<span class="php-var">$hFormat</span>); <span class="php-comment">//Response type for browser</span>
</span><span id="685" class="l"><a href="#685">685: </a>                <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Cache-Control: must-revalidate&quot;</span>);
</span><span id="686" class="l"><a href="#686">686: </a>                <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Pragma: must-revalidate&quot;</span>);
</span><span id="687" class="l"><a href="#687">687: </a>                <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-type: &quot;</span>.<span class="php-var">$hFormat</span>.<span class="php-quote">'; charset=UTF-8'</span>);
</span><span id="688" class="l"><a href="#688">688: </a>                <span class="php-keyword2">header</span>(<span class="php-quote">&quot;Content-disposition: attachment; filename=&quot;</span>.<span class="php-var">$filename</span>.<span class="php-quote">'.'</span>.<span class="php-var">$format</span>);
</span><span id="689" class="l"><a href="#689">689: </a>            } <span class="php-keyword1">else</span> {
</span><span id="690" class="l"><a href="#690">690: </a>                <span class="php-var">$this</span>-&gt;response-&gt;type(<span class="php-var">$hFormat</span>); <span class="php-comment">//Response type for browser</span>
</span><span id="691" class="l"><a href="#691">691: </a>            }
</span><span id="692" class="l"><a href="#692">692: </a>        } <span class="php-keyword1">else</span>
</span><span id="693" class="l"><a href="#693">693: </a>            <span class="php-var">$format</span> = <span class="php-quote">'json'</span>;
</span><span id="694" class="l"><a href="#694">694: </a>
</span><span id="695" class="l"><a href="#695">695: </a>
</span><span id="696" class="l"><a href="#696">696: </a>        <span class="php-var">$this</span>-&gt;Value-&gt;Behaviors-&gt;load(<span class="php-quote">'Containable'</span>); <span class="php-comment">//Containable makes it possible to fetch multiple related objects from the Db without forumlating SQL Queries</span>
</span><span id="697" class="l"><a href="#697">697: </a>
</span><span id="698" class="l"><a href="#698">698: </a>        <span class="php-var">$conds</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'Measure.timestamp &gt;='</span> =&gt; <span class="php-var">$start</span>, <span class="php-quote">'Measure.timestamp &lt;'</span> =&gt; <span class="php-var">$end</span>); <span class="php-comment">//Conditions for Measures, only export from given time range and only verified measures</span>
</span><span id="699" class="l"><a href="#699">699: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$p</span>[<span class="php-quote">'deleted'</span>]) <span class="php-comment">//If deleted data should not be included filter by states</span>
</span><span id="700" class="l"><a href="#700">700: </a>             <span class="php-var">$conds</span>[<span class="php-quote">'Measure.state &gt;='</span>] = <span class="php-num">0</span>;
</span><span id="701" class="l"><a href="#701">701: </a>        <span class="php-var">$vconds</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'Value.project_id'</span> =&gt; <span class="php-var">$id</span>); <span class="php-comment">//Conditions for Values</span>
</span><span id="702" class="l"><a href="#702">702: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$p</span>[<span class="php-quote">'values'</span>]) {
</span><span id="703" class="l"><a href="#703">703: </a>            <span class="php-var">$values</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$p</span>[<span class="php-quote">'values'</span>]);
</span><span id="704" class="l"><a href="#704">704: </a>            <span class="php-var">$vconds</span>[<span class="php-quote">'Value.id'</span>] = <span class="php-var">$values</span>;
</span><span id="705" class="l"><a href="#705">705: </a>        } <span class="php-keyword1">else</span> <span class="php-keyword1">if</span>(<span class="php-var">$export</span>) {
</span><span id="706" class="l"><a href="#706">706: </a>            <span class="php-var">$values</span> = <span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$export</span>[<span class="php-quote">'Export'</span>][<span class="php-quote">'value_ids'</span>]);
</span><span id="707" class="l"><a href="#707">707: </a>            <span class="php-var">$vconds</span>[<span class="php-quote">'Value.id'</span>] = <span class="php-var">$values</span>;
</span><span id="708" class="l"><a href="#708">708: </a>        } 
</span><span id="709" class="l"><a href="#709">709: </a>        <span class="php-var">$value_ids</span> = <span class="php-var">$this</span>-&gt;Value-&gt;find(<span class="php-quote">'list'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'fields'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'id'</span>, <span class="php-quote">'id'</span>), <span class="php-quote">'conditions'</span> =&gt; <span class="php-var">$vconds</span>)); 
</span><span id="710" class="l"><a href="#710">710: </a>        <span class="php-var">$options</span> = <span class="php-keyword1">array</span>(
</span><span id="711" class="l"><a href="#711">711: </a>            <span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Value.id'</span> =&gt; <span class="php-var">$value_ids</span>), 
</span><span id="712" class="l"><a href="#712">712: </a>            <span class="php-quote">'contain'</span> =&gt; <span class="php-keyword1">array</span>(
</span><span id="713" class="l"><a href="#713">713: </a>                <span class="php-quote">'Measure'</span> =&gt; <span class="php-keyword1">array</span>(
</span><span id="714" class="l"><a href="#714">714: </a>                    <span class="php-quote">'fields'</span> =&gt; <span class="php-quote">'data,timestamp'</span>.(<span class="php-var">$p</span>[<span class="php-quote">'states'</span>] ? <span class="php-quote">',state'</span> : <span class="php-quote">''</span>), 
</span><span id="715" class="l"><a href="#715">715: </a>                    <span class="php-quote">'conditions'</span> =&gt; <span class="php-var">$conds</span>, 
</span><span id="716" class="l"><a href="#716">716: </a>                    <span class="php-quote">'order'</span> =&gt; <span class="php-quote">'Measure.timestamp ASC'</span>), 
</span><span id="717" class="l"><a href="#717">717: </a>                <span class="php-quote">'Unit'</span>), 
</span><span id="718" class="l"><a href="#718">718: </a>            <span class="php-quote">'order'</span> =&gt; <span class="php-quote">''</span>
</span><span id="719" class="l"><a href="#719">719: </a>        );
</span><span id="720" class="l"><a href="#720">720: </a>
</span><span id="721" class="l"><a href="#721">721: </a>        <span class="php-var">$values</span> = <span class="php-var">$this</span>-&gt;Value-&gt;find(<span class="php-quote">'all'</span>, <span class="php-var">$options</span>);
</span><span id="722" class="l"><a href="#722">722: </a>        
</span><span id="723" class="l"><a href="#723">723: </a>        <span class="php-comment">//Build rows for CSV (one row for each timestamp)</span>
</span><span id="724" class="l"><a href="#724">724: </a>        <span class="php-var">$data</span> = <span class="php-keyword1">array</span>();
</span><span id="725" class="l"><a href="#725">725: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$v</span>){ <span class="php-comment">//Find all timestamps</span>
</span><span id="726" class="l"><a href="#726">726: </a>            <span class="php-var">$values</span>[<span class="php-var">$i</span>][<span class="php-quote">'Measure'</span>] = <span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>] = Set::combine(<span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>], <span class="php-quote">'{n}.timestamp'</span>, <span class="php-quote">'{n}'</span>);
</span><span id="727" class="l"><a href="#727">727: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>] <span class="php-keyword1">as</span> <span class="php-var">$timestamp</span> =&gt; <span class="php-var">$m</span>) {
</span><span id="728" class="l"><a href="#728">728: </a>                <span class="php-keyword1">if</span>(!<span class="php-var">$data</span>[<span class="php-var">$timestamp</span>])
</span><span id="729" class="l"><a href="#729">729: </a>                    <span class="php-var">$data</span>[<span class="php-var">$timestamp</span>] = <span class="php-keyword1">array</span>(); <span class="php-comment">//Create empty row for timestamp</span>
</span><span id="730" class="l"><a href="#730">730: </a>            }
</span><span id="731" class="l"><a href="#731">731: </a>        }
</span><span id="732" class="l"><a href="#732">732: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$values</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$v</span>){ 
</span><span id="733" class="l"><a href="#733">733: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$data</span> <span class="php-keyword1">as</span> <span class="php-var">$timestamp</span> =&gt; <span class="php-var">$d</span>) {
</span><span id="734" class="l"><a href="#734">734: </a>                <span class="php-var">$data</span>[<span class="php-var">$timestamp</span>][] = <span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>][<span class="php-var">$timestamp</span>][<span class="php-quote">'data'</span>]; <span class="php-comment">//Fill the rows with the data (If there is no data for the timestamp for one value it will be empty)</span>
</span><span id="735" class="l"><a href="#735">735: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$p</span>[<span class="php-quote">'states'</span>]) {
</span><span id="736" class="l"><a href="#736">736: </a>                    <span class="php-comment">//debug($v['Measure'][$timestamp]);</span>
</span><span id="737" class="l"><a href="#737">737: </a>                    <span class="php-var">$data</span>[<span class="php-var">$timestamp</span>][] = <span class="php-var">$v</span>[<span class="php-quote">'Measure'</span>][<span class="php-var">$timestamp</span>][<span class="php-quote">'state'</span>];
</span><span id="738" class="l"><a href="#738">738: </a>                }
</span><span id="739" class="l"><a href="#739">739: </a>            }
</span><span id="740" class="l"><a href="#740">740: </a>        }
</span><span id="741" class="l"><a href="#741">741: </a>        
</span><span id="742" class="l"><a href="#742">742: </a>        <span class="php-comment">//Parse the date formats</span>
</span><span id="743" class="l"><a href="#743">743: </a>        <span class="php-var">$dateformats</span> = <span class="php-keyword2">array_reverse</span>(<span class="php-keyword2">explode</span>(<span class="php-quote">','</span>, <span class="php-var">$this</span>-&gt;p[<span class="php-quote">'dateformat'</span>]));
</span><span id="744" class="l"><a href="#744">744: </a>        <span class="php-var">$hasDateformats</span> = <span class="php-keyword2">count</span>(<span class="php-var">$dateformats</span>);
</span><span id="745" class="l"><a href="#745">745: </a>        <span class="php-var">$timestampNames</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'timestamp'</span>);
</span><span id="746" class="l"><a href="#746">746: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$hasDateformats</span>) {
</span><span id="747" class="l"><a href="#747">747: </a>            <span class="php-keyword1">foreach</span>(<span class="php-var">$dateformats</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$df</span>) {
</span><span id="748" class="l"><a href="#748">748: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$i</span> == <span class="php-num">0</span>) <span class="php-keyword1">continue</span>;
</span><span id="749" class="l"><a href="#749">749: </a>                <span class="php-var">$timestampNames</span>[] = <span class="php-quote">'time'</span>.(<span class="php-var">$i</span> + <span class="php-num">1</span>); <span class="php-comment">//Set the timestamp names for the header</span>
</span><span id="750" class="l"><a href="#750">750: </a>            }
</span><span id="751" class="l"><a href="#751">751: </a>        }
</span><span id="752" class="l"><a href="#752">752: </a>        <span class="php-comment">//add the timestamps</span>
</span><span id="753" class="l"><a href="#753">753: </a>        <span class="php-keyword1">foreach</span>(<span class="php-var">$data</span> <span class="php-keyword1">as</span> <span class="php-var">$i</span> =&gt; <span class="php-var">$d</span>) { 
</span><span id="754" class="l"><a href="#754">754: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$hasDateformats</span>) { <span class="php-comment">//Multiple timestamp formats</span>
</span><span id="755" class="l"><a href="#755">755: </a>                <span class="php-keyword1">foreach</span>(<span class="php-var">$dateformats</span> <span class="php-keyword1">as</span> <span class="php-var">$dateformat</span>)
</span><span id="756" class="l"><a href="#756">756: </a>                    <span class="php-keyword2">array_unshift</span>(<span class="php-var">$data</span>[<span class="php-var">$i</span>], <span class="php-keyword2">date</span>(<span class="php-var">$dateformat</span>, <span class="php-var">$i</span>)); 
</span><span id="757" class="l"><a href="#757">757: </a>            } <span class="php-keyword1">else</span> <span class="php-comment">//One timestamp formats</span>
</span><span id="758" class="l"><a href="#758">758: </a>                <span class="php-keyword2">array_unshift</span>(<span class="php-var">$data</span>[<span class="php-var">$i</span>], <span class="php-var">$i</span>);
</span><span id="759" class="l"><a href="#759">759: </a>        }
</span><span id="760" class="l"><a href="#760">760: </a>        
</span><span id="761" class="l"><a href="#761">761: </a>        <span class="php-var">$header</span> = <span class="php-keyword1">array</span>();
</span><span id="762" class="l"><a href="#762">762: </a>        <span class="php-keyword2">array_map</span>(<span class="php-keyword1">function</span>(<span class="php-var">$v</span>, <span class="php-var">$s</span>) <span class="php-keyword1">use</span> (&amp;<span class="php-var">$header</span>, <span class="php-var">$p</span>){ <span class="php-comment">//Set the header in the first row</span>
</span><span id="763" class="l"><a href="#763">763: </a>            <span class="php-var">$header</span>[] = <span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'name'</span>].<span class="php-quote">' ('</span>.<span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'prefix'</span>].<span class="php-var">$v</span>[<span class="php-quote">'Unit'</span>][<span class="php-quote">'symbol'</span>].<span class="php-quote">')'</span>; <span class="php-comment">//Set the header names for each value</span>
</span><span id="764" class="l"><a href="#764">764: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$p</span>[<span class="php-quote">'states'</span>])
</span><span id="765" class="l"><a href="#765">765: </a>                <span class="php-var">$header</span>[] = <span class="php-quote">'State '</span>.<span class="php-var">$v</span>[<span class="php-quote">'Value'</span>][<span class="php-quote">'name'</span>];
</span><span id="766" class="l"><a href="#766">766: </a>        }, <span class="php-var">$values</span>, <span class="php-var">$values</span>);
</span><span id="767" class="l"><a href="#767">767: </a>        <span class="php-var">$data</span>[<span class="php-num">0</span>] = <span class="php-keyword2">array_merge</span>(<span class="php-var">$timestampNames</span>, <span class="php-var">$header</span>);
</span><span id="768" class="l"><a href="#768">768: </a>        <span class="php-keyword2">ksort</span>(<span class="php-var">$data</span>);
</span><span id="769" class="l"><a href="#769">769: </a>        
</span><span id="770" class="l"><a href="#770">770: </a>        <span class="php-var">$this</span>-&gt;writeLog(<span class="php-quote">'exported'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$project_id</span>, <span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>), <span class="php-quote">'related'</span> =&gt;  <span class="php-var">$export_id</span>)); 
</span><span id="771" class="l"><a href="#771">771: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'data'</span>, <span class="php-quote">'debug'</span>, <span class="php-quote">'format'</span>));
</span><span id="772" class="l"><a href="#772">772: </a>    }
</span><span id="773" class="l"><a href="#773">773: </a>    
</span><span id="774" class="l"><a href="#774">774: </a>    <span class="php-comment">/**
</span></span><span id="775" class="l"><a href="#775">775: </a><span class="php-comment">     * invite method
</span></span><span id="776" class="l"><a href="#776">776: </a><span class="php-comment">     * @param project_id Project ID of project to which a user is invited
</span></span><span id="777" class="l"><a href="#777">777: </a><span class="php-comment">     * @return void
</span></span><span id="778" class="l"><a href="#778">778: </a><span class="php-comment">     */</span>
</span><span id="779" class="l"><a href="#779">779: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> invite(<span class="php-var">$project_id</span>) {
</span><span id="780" class="l"><a href="#780">780: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$this</span>-&gt;authorizedProject(<span class="php-var">$project_id</span>, console::<span class="php-var">$contributorState</span>)) {
</span><span id="781" class="l"><a href="#781">781: </a>            <span class="php-keyword1">return</span>;
</span><span id="782" class="l"><a href="#782">782: </a>        }
</span><span id="783" class="l"><a href="#783">783: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'User'</span>);
</span><span id="784" class="l"><a href="#784">784: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;Behaviors-&gt;load(<span class="php-quote">'Containable'</span>);
</span><span id="785" class="l"><a href="#785">785: </a>        <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Project'</span>][<span class="php-quote">'id'</span>] = <span class="php-var">$project_id</span>;
</span><span id="786" class="l"><a href="#786">786: </a>        <span class="php-var">$project</span> = <span class="php-var">$this</span>-&gt;Project-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-quote">'id=&quot;'</span>.<span class="php-var">$project_id</span>.<span class="php-quote">'&quot;'</span>, <span class="php-quote">'contain'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Member'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'fields'</span> =&gt; <span class="php-quote">'id,id'</span>))));
</span><span id="787" class="l"><a href="#787">787: </a>        <span class="php-var">$members</span> = Set::<span class="php-keyword2">extract</span>(<span class="php-var">$project</span>[<span class="php-quote">'Member'</span>], <span class="php-quote">'{n}.id'</span>);
</span><span id="788" class="l"><a href="#788">788: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'project'</span>));
</span><span id="789" class="l"><a href="#789">789: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'post'</span>) || <span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'put'</span>)) {
</span><span id="790" class="l"><a href="#790">790: </a>            <span class="php-var">$this</span>-&gt;Project-&gt;id = <span class="php-var">$project_id</span>;
</span><span id="791" class="l"><a href="#791">791: </a>            <span class="php-var">$member</span> = <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Member'</span>][<span class="php-quote">'Member'</span>][<span class="php-num">0</span>];
</span><span id="792" class="l"><a href="#792">792: </a>            <span class="php-var">$user</span> = <span class="php-var">$this</span>-&gt;User-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'LOWER(email)'</span> =&gt; <span class="php-keyword2">strtolower</span>(<span class="php-var">$member</span>[<span class="php-quote">'email'</span>]))));
</span><span id="793" class="l"><a href="#793">793: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$user</span>) {
</span><span id="794" class="l"><a href="#794">794: </a>                <span class="php-var">$user_id</span> = <span class="php-var">$user</span>[<span class="php-quote">'User'</span>][<span class="php-quote">'id'</span>];
</span><span id="795" class="l"><a href="#795">795: </a>            } <span class="php-keyword1">else</span> {
</span><span id="796" class="l"><a href="#796">796: </a>                <span class="php-var">$code</span> = <span class="php-keyword2">uniqid</span>();
</span><span id="797" class="l"><a href="#797">797: </a>                <span class="php-var">$pw</span> = <span class="php-keyword2">uniqid</span>();
</span><span id="798" class="l"><a href="#798">798: </a>                <span class="php-var">$user</span> = <span class="php-keyword1">array</span>(<span class="php-quote">'email'</span> =&gt; <span class="php-keyword2">strtolower</span>(<span class="php-var">$member</span>[<span class="php-quote">'email'</span>]), <span class="php-quote">'password'</span> =&gt; <span class="php-var">$pw</span>, <span class="php-quote">'activation_code'</span> =&gt; <span class="php-var">$code</span>, <span class="php-quote">'name'</span> =&gt; <span class="php-keyword2">strtolower</span>(<span class="php-var">$member</span>[<span class="php-quote">'email'</span>]));
</span><span id="799" class="l"><a href="#799">799: </a>                <span class="php-var">$this</span>-&gt;User-&gt;create();
</span><span id="800" class="l"><a href="#800">800: </a>                <span class="php-keyword1">if</span>(<span class="php-var">$this</span>-&gt;User-&gt;save(<span class="php-var">$user</span>)) {
</span><span id="801" class="l"><a href="#801">801: </a>                    <span class="php-var">$user_id</span> = <span class="php-var">$this</span>-&gt;User-&gt;getLastInsertId();
</span><span id="802" class="l"><a href="#802">802: </a>                    <span class="php-keyword1">if</span>(!<span class="php-var">$this</span>-&gt;isLocalhost) {
</span><span id="803" class="l"><a href="#803">803: </a>                        <span class="php-var">$this</span>-&gt;er(<span class="php-quote">'SENDING'</span>);
</span><span id="804" class="l"><a href="#804">804: </a>                        App::uses(<span class="php-quote">'CakeEmail'</span>, <span class="php-quote">'Network/Email'</span>);
</span><span id="805" class="l"><a href="#805">805: </a>                        <span class="php-var">$email</span> = <span class="php-keyword1">new</span> CakeEmail();
</span><span id="806" class="l"><a href="#806">806: </a>                        <span class="php-var">$sent</span> = <span class="php-var">$email</span>
</span><span id="807" class="l"><a href="#807">807: </a>                            -&gt;from(console::<span class="php-var">$noreplyEmail</span>)-&gt;to(<span class="php-var">$member</span>[<span class="php-quote">'email'</span>])
</span><span id="808" class="l"><a href="#808">808: </a>                            -&gt;template(<span class="php-quote">'invited'</span>)
</span><span id="809" class="l"><a href="#809">809: </a>                            -&gt;emailFormat(<span class="php-quote">'html'</span>)
</span><span id="810" class="l"><a href="#810">810: </a>                            -&gt;subject(__(<span class="php-quote">'You have been invited to '</span>.console::<span class="php-var">$systemName</span>))
</span><span id="811" class="l"><a href="#811">811: </a>                            -&gt;viewVars(<span class="php-keyword1">array</span>(
</span><span id="812" class="l"><a href="#812">812: </a>                                <span class="php-quote">'user'</span> =&gt; <span class="php-var">$user</span>, 
</span><span id="813" class="l"><a href="#813">813: </a>                                <span class="php-quote">'email'</span> =&gt; <span class="php-var">$member</span>[<span class="php-quote">'email'</span>], 
</span><span id="814" class="l"><a href="#814">814: </a>                                <span class="php-quote">'project'</span> =&gt; <span class="php-var">$project</span>,
</span><span id="815" class="l"><a href="#815">815: </a>                                <span class="php-quote">'password'</span> =&gt; <span class="php-var">$pw</span>,
</span><span id="816" class="l"><a href="#816">816: </a>                                <span class="php-quote">'authUser'</span> =&gt; <span class="php-var">$this</span>-&gt;Auth-&gt;user(),
</span><span id="817" class="l"><a href="#817">817: </a>                                <span class="php-quote">'loginLink'</span> =&gt; Router::url(<span class="php-keyword1">array</span>(<span class="php-quote">'controller'</span> =&gt; <span class="php-quote">'users'</span>, <span class="php-quote">'action'</span> =&gt; <span class="php-quote">'login'</span>), <span class="php-keyword1">true</span>), 
</span><span id="818" class="l"><a href="#818">818: </a>                                <span class="php-quote">'activateLink'</span> =&gt; Router::url(<span class="php-keyword1">array</span>(<span class="php-quote">'controller'</span> =&gt; <span class="php-quote">'users'</span>, <span class="php-quote">'action'</span> =&gt; <span class="php-quote">'activateAccount'</span>, <span class="php-quote">'?'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'activation'</span> =&gt; <span class="php-var">$code</span>)), <span class="php-keyword1">true</span>)))
</span><span id="819" class="l"><a href="#819">819: </a>                            -&gt;send();
</span><span id="820" class="l"><a href="#820">820: </a>                        <span class="php-var">$this</span>-&gt;er(<span class="php-quote">'SENT:'</span>.<span class="php-var">$sent</span>);
</span><span id="821" class="l"><a href="#821">821: </a>                    }
</span><span id="822" class="l"><a href="#822">822: </a>                } <span class="php-keyword1">else</span> { <span class="php-comment">//User could not be invited</span>
</span><span id="823" class="l"><a href="#823">823: </a>                    <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'The user could not be invited.'</span>));
</span><span id="824" class="l"><a href="#824">824: </a>                    <span class="php-keyword1">return</span>;
</span><span id="825" class="l"><a href="#825">825: </a>                }
</span><span id="826" class="l"><a href="#826">826: </a>            }
</span><span id="827" class="l"><a href="#827">827: </a>            <span class="php-keyword1">if</span>(<span class="php-keyword2">array_search</span>(<span class="php-var">$user_id</span>, <span class="php-var">$members</span>) !== <span class="php-keyword1">false</span>) { <span class="php-comment">//User already invited</span>
</span><span id="828" class="l"><a href="#828">828: </a>                <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'The user has already been invited. If you want to change his rights you have to uninvite and reinvite him.'</span>));
</span><span id="829" class="l"><a href="#829">829: </a>                <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'view'</span>, <span class="php-var">$project_id</span>));
</span><span id="830" class="l"><a href="#830">830: </a>                <span class="php-keyword1">return</span>;
</span><span id="831" class="l"><a href="#831">831: </a>            }
</span><span id="832" class="l"><a href="#832">832: </a>            <span class="php-var">$members</span>[] = <span class="php-var">$user_id</span>;
</span><span id="833" class="l"><a href="#833">833: </a>            <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Member'</span>][<span class="php-quote">'Member'</span>] = <span class="php-var">$members</span>;
</span><span id="834" class="l"><a href="#834">834: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;Project-&gt;saveAll(<span class="php-var">$this</span>-&gt;request-&gt;data)) {
</span><span id="835" class="l"><a href="#835">835: </a>                <span class="php-var">$this</span>-&gt;Project-&gt;query(<span class="php-quote">'UPDATE projects_users SET state='</span>.<span class="php-var">$member</span>[<span class="php-quote">'state'</span>].<span class="php-quote">' WHERE user_id=&quot;'</span>.<span class="php-var">$user_id</span>.<span class="php-quote">'&quot; AND project_id=&quot;'</span>.<span class="php-var">$project_id</span>.<span class="php-quote">'&quot;'</span>);
</span><span id="836" class="l"><a href="#836">836: </a>                <span class="php-var">$this</span>-&gt;writeLog(<span class="php-quote">'invited'</span>, <span class="php-keyword1">array</span>(<span class="php-var">$project_id</span>, <span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>), <span class="php-quote">'related'</span> =&gt; <span class="php-var">$user_id</span>));
</span><span id="837" class="l"><a href="#837">837: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The user has been invited'</span>));
</span><span id="838" class="l"><a href="#838">838: </a>                <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'view'</span>, <span class="php-var">$project_id</span>));
</span><span id="839" class="l"><a href="#839">839: </a>            } <span class="php-keyword1">else</span> {
</span><span id="840" class="l"><a href="#840">840: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The user could not be invited. Please, try again.'</span>));
</span><span id="841" class="l"><a href="#841">841: </a>            }
</span><span id="842" class="l"><a href="#842">842: </a>        }
</span><span id="843" class="l"><a href="#843">843: </a>    }
</span><span id="844" class="l"><a href="#844">844: </a>    
</span><span id="845" class="l"><a href="#845">845: </a>    <span class="php-comment">/**
</span></span><span id="846" class="l"><a href="#846">846: </a><span class="php-comment">     * uninvite a user from a project
</span></span><span id="847" class="l"><a href="#847">847: </a><span class="php-comment">     * @param $project_id Project ID
</span></span><span id="848" class="l"><a href="#848">848: </a><span class="php-comment">     * @param $user_id User ID of the user to be uninvited
</span></span><span id="849" class="l"><a href="#849">849: </a><span class="php-comment">     * @return void
</span></span><span id="850" class="l"><a href="#850">850: </a><span class="php-comment">     */</span>
</span><span id="851" class="l"><a href="#851">851: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> uninvite(<span class="php-var">$project_id</span>, <span class="php-var">$user_id</span>) {
</span><span id="852" class="l"><a href="#852">852: </a>        <span class="php-keyword1">if</span>(!<span class="php-var">$this</span>-&gt;authorizedProject(<span class="php-var">$project_id</span>, console::<span class="php-var">$contributorState</span>)) {
</span><span id="853" class="l"><a href="#853">853: </a>            <span class="php-keyword1">return</span>;
</span><span id="854" class="l"><a href="#854">854: </a>        }
</span><span id="855" class="l"><a href="#855">855: </a>        <span class="php-var">$this</span>-&gt;loadModel(<span class="php-quote">'User'</span>);
</span><span id="856" class="l"><a href="#856">856: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;Behaviors-&gt;load(<span class="php-quote">'Containable'</span>);
</span><span id="857" class="l"><a href="#857">857: </a>        <span class="php-var">$project</span> = <span class="php-var">$this</span>-&gt;Project-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-quote">'id=&quot;'</span>.<span class="php-var">$project_id</span>.<span class="php-quote">'&quot;'</span>, <span class="php-quote">'contain'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'Member'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'fields'</span> =&gt; <span class="php-quote">'id,id'</span>))));
</span><span id="858" class="l"><a href="#858">858: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$project</span>[<span class="php-quote">'Project'</span>][<span class="php-quote">'user_id'</span>] == <span class="php-var">$user_id</span>) {
</span><span id="859" class="l"><a href="#859">859: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'The project admin cannot be uninvited.'</span>));
</span><span id="860" class="l"><a href="#860">860: </a>            <span class="php-keyword1">return</span>;
</span><span id="861" class="l"><a href="#861">861: </a>        }
</span><span id="862" class="l"><a href="#862">862: </a>        <span class="php-var">$members</span> = Set::<span class="php-keyword2">extract</span>(<span class="php-var">$project</span>[<span class="php-quote">'Member'</span>], <span class="php-quote">'{n}.id'</span>);
</span><span id="863" class="l"><a href="#863">863: </a>        <span class="php-var">$this</span>-&gt;set(<span class="php-keyword2">compact</span>(<span class="php-quote">'project'</span>));
</span><span id="864" class="l"><a href="#864">864: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'post'</span>) || <span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'put'</span>)) {
</span><span id="865" class="l"><a href="#865">865: </a>            <span class="php-var">$user</span> = <span class="php-var">$this</span>-&gt;User-&gt;find(<span class="php-quote">'first'</span>, <span class="php-keyword1">array</span>(<span class="php-quote">'conditions'</span> =&gt; <span class="php-keyword1">array</span>(<span class="php-quote">'LOWER(email)'</span> =&gt; <span class="php-keyword2">strtolower</span>(<span class="php-var">$member</span>[<span class="php-quote">'email'</span>]))));
</span><span id="866" class="l"><a href="#866">866: </a>            <span class="php-var">$pos</span> = <span class="php-keyword2">array_search</span>(<span class="php-var">$user_id</span>, <span class="php-var">$members</span>);
</span><span id="867" class="l"><a href="#867">867: </a>            <span class="php-keyword1">if</span>(<span class="php-var">$pos</span> === <span class="php-keyword1">false</span>) { <span class="php-comment">//User already invited</span>
</span><span id="868" class="l"><a href="#868">868: </a>                <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'The user is not invited and cannot be uninvited.'</span>));
</span><span id="869" class="l"><a href="#869">869: </a>                <span class="php-keyword1">return</span>;
</span><span id="870" class="l"><a href="#870">870: </a>            }
</span><span id="871" class="l"><a href="#871">871: </a>            <span class="php-keyword1">unset</span>(<span class="php-var">$members</span>[<span class="php-var">$pos</span>]);
</span><span id="872" class="l"><a href="#872">872: </a>            <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Project'</span>][<span class="php-quote">'id'</span>] = <span class="php-var">$project_id</span>;
</span><span id="873" class="l"><a href="#873">873: </a>            <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Member'</span>][<span class="php-quote">'Member'</span>] = <span class="php-var">$members</span>;
</span><span id="874" class="l"><a href="#874">874: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;Project-&gt;saveAll(<span class="php-var">$this</span>-&gt;request-&gt;data)) {
</span><span id="875" class="l"><a href="#875">875: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The user has been uninvited'</span>));
</span><span id="876" class="l"><a href="#876">876: </a>                <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'view'</span>, <span class="php-var">$project_id</span>));
</span><span id="877" class="l"><a href="#877">877: </a>            } <span class="php-keyword1">else</span> {
</span><span id="878" class="l"><a href="#878">878: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The user could not be invited. Please, try again.'</span>));
</span><span id="879" class="l"><a href="#879">879: </a>            }
</span><span id="880" class="l"><a href="#880">880: </a>        }
</span><span id="881" class="l"><a href="#881">881: </a>    }
</span><span id="882" class="l"><a href="#882">882: </a>
</span><span id="883" class="l"><a href="#883">883: </a>    <span class="php-comment">/**
</span></span><span id="884" class="l"><a href="#884">884: </a><span class="php-comment">     * add method
</span></span><span id="885" class="l"><a href="#885">885: </a><span class="php-comment">     *
</span></span><span id="886" class="l"><a href="#886">886: </a><span class="php-comment">     * @return void
</span></span><span id="887" class="l"><a href="#887">887: </a><span class="php-comment">     */</span>
</span><span id="888" class="l"><a href="#888">888: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> add() {
</span><span id="889" class="l"><a href="#889">889: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'post'</span>)) {
</span><span id="890" class="l"><a href="#890">890: </a>            <span class="php-var">$this</span>-&gt;Project-&gt;create();
</span><span id="891" class="l"><a href="#891">891: </a>            <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Member'</span>][<span class="php-quote">'Member'</span>][<span class="php-num">0</span>] = <span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>);
</span><span id="892" class="l"><a href="#892">892: </a>            <span class="php-var">$this</span>-&gt;request-&gt;data[<span class="php-quote">'Project'</span>][<span class="php-quote">'user_id'</span>] = <span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>);
</span><span id="893" class="l"><a href="#893">893: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;Project-&gt;saveAll(<span class="php-var">$this</span>-&gt;request-&gt;data)) {
</span><span id="894" class="l"><a href="#894">894: </a>                <span class="php-var">$id</span> = <span class="php-var">$this</span>-&gt;Project-&gt;getLastInsertId();
</span><span id="895" class="l"><a href="#895">895: </a>                <span class="php-var">$this</span>-&gt;Project-&gt;query(<span class="php-quote">'UPDATE projects_users SET state='</span>.console::<span class="php-var">$adminState</span>.<span class="php-quote">' WHERE user_id=&quot;'</span>.<span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>).<span class="php-quote">'&quot; AND project_id=&quot;'</span>.<span class="php-var">$id</span>.<span class="php-quote">'&quot;'</span>);
</span><span id="896" class="l"><a href="#896">896: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The project has been saved'</span>));
</span><span id="897" class="l"><a href="#897">897: </a>                <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'index'</span>));
</span><span id="898" class="l"><a href="#898">898: </a>            } <span class="php-keyword1">else</span> {
</span><span id="899" class="l"><a href="#899">899: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The project could not be saved. Please, try again.'</span>));
</span><span id="900" class="l"><a href="#900">900: </a>            }
</span><span id="901" class="l"><a href="#901">901: </a>        }
</span><span id="902" class="l"><a href="#902">902: </a>    }
</span><span id="903" class="l"><a href="#903">903: </a>
</span><span id="904" class="l"><a href="#904">904: </a>    <span class="php-comment">/**
</span></span><span id="905" class="l"><a href="#905">905: </a><span class="php-comment">     * edit method
</span></span><span id="906" class="l"><a href="#906">906: </a><span class="php-comment">     *
</span></span><span id="907" class="l"><a href="#907">907: </a><span class="php-comment">     * @throws NotFoundException
</span></span><span id="908" class="l"><a href="#908">908: </a><span class="php-comment">     * @param string $id ID of the project to be edited
</span></span><span id="909" class="l"><a href="#909">909: </a><span class="php-comment">     * @return void
</span></span><span id="910" class="l"><a href="#910">910: </a><span class="php-comment">     */</span>
</span><span id="911" class="l"><a href="#911">911: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> edit(<span class="php-var">$id</span> = <span class="php-keyword1">null</span>) {
</span><span id="912" class="l"><a href="#912">912: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;id = <span class="php-var">$id</span>;
</span><span id="913" class="l"><a href="#913">913: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Project-&gt;exists()) {
</span><span id="914" class="l"><a href="#914">914: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid project'</span>));
</span><span id="915" class="l"><a href="#915">915: </a>        }
</span><span id="916" class="l"><a href="#916">916: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'post'</span>) || <span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'put'</span>)) {
</span><span id="917" class="l"><a href="#917">917: </a>            <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;Project-&gt;save(<span class="php-var">$this</span>-&gt;request-&gt;data)) {
</span><span id="918" class="l"><a href="#918">918: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The project has been saved'</span>));
</span><span id="919" class="l"><a href="#919">919: </a>                <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'view'</span>, <span class="php-var">$id</span>));
</span><span id="920" class="l"><a href="#920">920: </a>            } <span class="php-keyword1">else</span> {
</span><span id="921" class="l"><a href="#921">921: </a>                <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'The project could not be saved. Please, try again.'</span>));
</span><span id="922" class="l"><a href="#922">922: </a>            }
</span><span id="923" class="l"><a href="#923">923: </a>        } <span class="php-keyword1">else</span> {
</span><span id="924" class="l"><a href="#924">924: </a>            <span class="php-var">$this</span>-&gt;request-&gt;data = <span class="php-var">$this</span>-&gt;Project-&gt;read(<span class="php-keyword1">null</span>, <span class="php-var">$id</span>);
</span><span id="925" class="l"><a href="#925">925: </a>        }
</span><span id="926" class="l"><a href="#926">926: </a>        <span class="php-var">$this</span>-&gt;render(<span class="php-quote">'add'</span>);
</span><span id="927" class="l"><a href="#927">927: </a>    }
</span><span id="928" class="l"><a href="#928">928: </a>
</span><span id="929" class="l"><a href="#929">929: </a>    <span class="php-comment">/**
</span></span><span id="930" class="l"><a href="#930">930: </a><span class="php-comment">     * delete method
</span></span><span id="931" class="l"><a href="#931">931: </a><span class="php-comment">     *
</span></span><span id="932" class="l"><a href="#932">932: </a><span class="php-comment">     * @throws MethodNotAllowedException
</span></span><span id="933" class="l"><a href="#933">933: </a><span class="php-comment">     * @throws NotFoundException
</span></span><span id="934" class="l"><a href="#934">934: </a><span class="php-comment">     * @param string $id Project ID
</span></span><span id="935" class="l"><a href="#935">935: </a><span class="php-comment">     * @return void
</span></span><span id="936" class="l"><a href="#936">936: </a><span class="php-comment">     */</span>
</span><span id="937" class="l"><a href="#937">937: </a>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> <span class="php-keyword2">delete</span>(<span class="php-var">$id</span> = <span class="php-keyword1">null</span>) {
</span><span id="938" class="l"><a href="#938">938: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;request-&gt;is(<span class="php-quote">'post'</span>)) {
</span><span id="939" class="l"><a href="#939">939: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> MethodNotAllowedException();
</span><span id="940" class="l"><a href="#940">940: </a>        }
</span><span id="941" class="l"><a href="#941">941: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;id = <span class="php-var">$id</span>;
</span><span id="942" class="l"><a href="#942">942: </a>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;Project-&gt;exists()) {
</span><span id="943" class="l"><a href="#943">943: </a>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> NotFoundException(__(<span class="php-quote">'Invalid project'</span>));
</span><span id="944" class="l"><a href="#944">944: </a>        }
</span><span id="945" class="l"><a href="#945">945: </a>        <span class="php-var">$this</span>-&gt;Project-&gt;recursive = <span class="php-num">0</span>;
</span><span id="946" class="l"><a href="#946">946: </a>        <span class="php-var">$user_id</span> = <span class="php-var">$this</span>-&gt;Project-&gt;read(<span class="php-quote">'user_id'</span>, <span class="php-var">$id</span>);
</span><span id="947" class="l"><a href="#947">947: </a>        <span class="php-var">$user_id</span> = <span class="php-var">$user_id</span>[<span class="php-quote">'Project'</span>][<span class="php-quote">'user_id'</span>];
</span><span id="948" class="l"><a href="#948">948: </a>        <span class="php-keyword1">if</span>(<span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'id'</span>) != <span class="php-var">$user_id</span> &amp;&amp; !<span class="php-var">$this</span>-&gt;Auth-&gt;user(<span class="php-quote">'isAdmin'</span>)) {
</span><span id="949" class="l"><a href="#949">949: </a>            <span class="php-var">$this</span>-&gt;er(__(<span class="php-quote">'Only the creator of a project can delete it.'</span>));
</span><span id="950" class="l"><a href="#950">950: </a>            <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'index'</span>));
</span><span id="951" class="l"><a href="#951">951: </a>            <span class="php-keyword1">return</span>;
</span><span id="952" class="l"><a href="#952">952: </a>        }
</span><span id="953" class="l"><a href="#953">953: </a>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;Project-&gt;<span class="php-keyword2">delete</span>()) {
</span><span id="954" class="l"><a href="#954">954: </a>            <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'Project deleted'</span>));
</span><span id="955" class="l"><a href="#955">955: </a>            <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'index'</span>));
</span><span id="956" class="l"><a href="#956">956: </a>        }
</span><span id="957" class="l"><a href="#957">957: </a>        <span class="php-var">$this</span>-&gt;Session-&gt;setFlash(__(<span class="php-quote">'Project was not deleted'</span>));
</span><span id="958" class="l"><a href="#958">958: </a>        <span class="php-var">$this</span>-&gt;redirect(<span class="php-keyword1">array</span>(<span class="php-quote">'action'</span> =&gt; <span class="php-quote">'index'</span>));
</span><span id="959" class="l"><a href="#959">959: </a>    }
</span><span id="960" class="l"><a href="#960">960: </a>}
</span><span id="961" class="l"><a href="#961">961: </a></span></code></pre>

	<div id="footer">
		 API documentation generated by <a href="http://apigen.org">ApiGen</a>
	</div>
</div>
</div>
<script src="resources/combined.js?7eb2692f9bc56ab5a33a225c0613d45106bc9048"></script>
<script src="elementlist.js?bee160a8365720e9c42c1e2f9b251a6503dc98fa"></script>
</body>
</html>
